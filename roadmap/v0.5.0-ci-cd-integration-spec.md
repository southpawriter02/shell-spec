# Shell-Spec v0.5.0 Specification: CI/CD Integration

## Overview

**Version**: 0.5.0
**Feature**: CI/CD Integration
**Status**: Planned
**Complexity**: Medium
**Estimated Lines of Code**: ~230 (new files only)
**Dependencies**: v0.4.0 (Code Coverage) should be complete first
**Compatibility**: All platforms (Linux, macOS); All shells (bash, zsh, sh)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Architecture](#2-architecture)
3. [Functional Specification](#3-functional-specification)
4. [Technical Design](#4-technical-design)
5. [Workflows](#5-workflows)
6. [Use Cases](#6-use-cases)
7. [Decision Trees](#7-decision-trees)
8. [Logging & Diagnostics](#8-logging--diagnostics)
9. [Documentation Requirements](#9-documentation-requirements)
10. [Deliverables Checklist](#10-deliverables-checklist)
11. [Testing Strategy](#11-testing-strategy)
12. [Acceptance Criteria](#12-acceptance-criteria)

---

## 1. Executive Summary

### 1.1 Purpose

Provide production-ready GitHub Actions CI/CD workflows for shell-spec, enabling automated testing across multiple platforms and shells, static analysis via ShellCheck, portability verification on Alpine Linux, and automated release management. This infrastructure serves as both the project's own CI/CD and as reference implementations for users adopting shell-spec.

### 1.2 Goals

- Automated testing across OS/shell matrix (Ubuntu, macOS × bash, zsh, sh)
- Static analysis with ShellCheck on all shell scripts
- Portability testing on Alpine Linux (musl libc)
- Automated GitHub releases on version tags
- Badge-ready CI status for README
- Reference CI configuration users can adapt

### 1.3 Non-Goals

- Windows/WSL support (future consideration)
- Self-hosted runner configurations
- Complex deployment pipelines (Kubernetes, cloud functions)
- Automated npm/Homebrew publishing (deferred to v0.6.0)
- Code coverage enforcement in CI (optional, not blocking)

### 1.4 Key Constraints

- Must work with GitHub Actions free tier
- Must complete within 10-minute job timeout
- Must handle shell feature differences gracefully
- Must not require secrets for PR validation
- Must fail fast on lint errors

---

## 2. Architecture

### 2.1 CI/CD Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GitHub Actions Ecosystem                             │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        .github/workflows/                            │   │
│  │                                                                      │   │
│  │  ┌─────────────────────┐      ┌─────────────────────────┐          │   │
│  │  │      ci.yml         │      │     release.yml         │          │   │
│  │  │                     │      │                         │          │   │
│  │  │  Triggers:          │      │  Triggers:              │          │   │
│  │  │  • push to main     │      │  • tags v*.*.*          │          │   │
│  │  │  • pull_request     │      │                         │          │   │
│  │  │  • workflow_dispatch│      │  Jobs:                  │          │   │
│  │  │                     │      │  • validate             │          │   │
│  │  │  Jobs:              │      │  • create-release       │          │   │
│  │  │  • lint             │      │  • upload-artifacts     │          │   │
│  │  │  • test (matrix)    │      │                         │          │   │
│  │  │  • portability      │      └─────────────────────────┘          │   │
│  │  └─────────────────────┘                                            │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Job Execution                                │   │
│  │                                                                      │   │
│  │  ┌───────────┐  ┌───────────────────────────────┐  ┌───────────┐   │   │
│  │  │   lint    │  │           test                │  │portability│   │   │
│  │  │           │  │                               │  │           │   │   │
│  │  │ ShellCheck│  │  ┌─────────────────────────┐ │  │  Alpine   │   │   │
│  │  │ on src/   │  │  │     Matrix Strategy     │ │  │  Linux    │   │   │
│  │  │           │  │  │                         │ │  │  (musl)   │   │   │
│  │  │ Uses:     │  │  │ OS:                     │ │  │           │   │   │
│  │  │ .shell-   │  │  │ • ubuntu-latest         │ │  │ Container:│   │   │
│  │  │ checkrc   │  │  │ • ubuntu-22.04          │ │  │ alpine:   │   │   │
│  │  │           │  │  │ • macos-latest          │ │  │ latest    │   │   │
│  │  └───────────┘  │  │ • macos-13              │ │  │           │   │   │
│  │       │         │  │                         │ │  │ Shell: sh │   │   │
│  │       │         │  │ Shell:                  │ │  └───────────┘   │   │
│  │       │         │  │ • bash                  │ │       │          │   │
│  │       │         │  │ • zsh                   │ │       │          │   │
│  │       │         │  │ • sh (Linux only)       │ │       │          │   │
│  │       │         │  └─────────────────────────┘ │       │          │   │
│  │       │         │              │                │       │          │   │
│  │       │         └──────────────┼────────────────┘       │          │   │
│  │       │                        │                        │          │   │
│  │       ▼                        ▼                        ▼          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                      Test Results                           │   │   │
│  │  │                                                             │   │   │
│  │  │  • Lint: PASS/FAIL                                         │   │   │
│  │  │  • Test Matrix: 10 combinations (see 2.3)                  │   │   │
│  │  │  • Portability: PASS/FAIL                                  │   │   │
│  │  │  • Status Badge: ✓ passing / ✗ failing                     │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 File Structure

```
.github/
├── workflows/
│   ├── ci.yml              # NEW: Main CI workflow (~100 lines)
│   └── release.yml         # NEW: Release automation (~120 lines)
└── CODEOWNERS              # OPTIONAL: Review requirements

.shellcheckrc               # NEW: ShellCheck configuration (~10 lines)

src/
├── test_runner.sh          # NO CHANGE
├── assertions.sh           # NO CHANGE
├── tap_reporter.sh         # NO CHANGE (from v0.2.0)
├── mocking.sh              # NO CHANGE (from v0.3.0)
├── coverage.sh             # NO CHANGE (from v0.4.0)
└── report_template.html    # NO CHANGE

tests/                      # Self-tests (may need creation)
├── assertions_test.sh      # Test assertion functions
├── runner_test.sh          # Test runner behavior
└── integration_test.sh     # End-to-end tests
```

### 2.3 Test Matrix Combinations

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CI Test Matrix (10 combinations)                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┬──────────────────────────────────────────────────────────┐
│     Platform     │                      Shells                              │
├──────────────────┼────────────┬────────────┬────────────┬──────────────────┤
│                  │    bash    │    zsh     │     sh     │      Notes       │
├──────────────────┼────────────┼────────────┼────────────┼──────────────────┤
│ ubuntu-latest    │     ✓      │     ✓      │     ✓      │ Primary target   │
│ ubuntu-22.04     │     ✓      │     ✓      │     ✓      │ LTS stability    │
│ macos-latest     │     ✓      │     ✓      │     ✗      │ No sh (dash)     │
│ macos-13         │     ✓      │     ✓      │     ✗      │ Intel Mac        │
├──────────────────┼────────────┼────────────┼────────────┼──────────────────┤
│ alpine:latest    │     ✗      │     ✗      │     ✓      │ Portability only │
└──────────────────┴────────────┴────────────┴────────────┴──────────────────┘

Matrix breakdown:
• Ubuntu (2 versions) × 3 shells = 6 combinations
• macOS (2 versions) × 2 shells = 4 combinations
• Alpine (portability job) = 1 separate job
────────────────────────────────────────────
Total: 10 test runs + 1 lint job = 11 jobs per CI run
```

### 2.4 Workflow Execution Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CI Workflow Execution Order                          │
└─────────────────────────────────────────────────────────────────────────────┘

  Event Trigger
  (push/PR/tag)
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ci.yml                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                            │
│  │    lint     │ ◄─── Runs FIRST (fast fail on syntax errors)              │
│  │  ShellCheck │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         │ on success                                                        │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         test (parallel)                              │   │
│  │                                                                      │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │   │
│  │  │ubuntu-latest │ │ubuntu-22.04  │ │ macos-latest │ │  macos-13  │  │   │
│  │  │   + bash     │ │   + bash     │ │   + bash     │ │   + bash   │  │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │   │
│  │  │ubuntu-latest │ │ubuntu-22.04  │ │ macos-latest │ │  macos-13  │  │   │
│  │  │   + zsh      │ │   + zsh      │ │   + zsh      │ │   + zsh    │  │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │   │
│  │  ┌──────────────┐ ┌──────────────┐                                   │   │
│  │  │ubuntu-latest │ │ubuntu-22.04  │                                   │   │
│  │  │   + sh       │ │   + sh       │   (sh not tested on macOS)       │   │
│  │  └──────────────┘ └──────────────┘                                   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         │ in parallel with test matrix                                      │
│         ▼                                                                   │
│  ┌─────────────────┐                                                        │
│  │   portability   │ ◄─── Alpine Linux container                           │
│  │  (Alpine/musl)  │                                                        │
│  └─────────────────┘                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
       │
       │ All jobs pass
       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CI Status: ✓ PASSING                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Functional Specification

### 3.1 CI Workflow Triggers

#### 3.1.1 Automatic Triggers

| Trigger | Condition | Jobs Run |
|---------|-----------|----------|
| `push` | Branch is `main` | All (lint, test, portability) |
| `pull_request` | Target is `main` | All (lint, test, portability) |
| `push` (tag) | Tag matches `v*.*.*` | release.yml instead |

#### 3.1.2 Manual Triggers

```yaml
workflow_dispatch:
  inputs:
    debug_enabled:
      description: 'Enable debug logging'
      required: false
      default: 'false'
```

**Purpose**: Allow manual CI runs with optional debug output.

### 3.2 Job Specifications

#### 3.2.1 Lint Job

**Purpose**: Static analysis of all shell scripts

**Configuration**:
| Setting | Value |
|---------|-------|
| Runner | `ubuntu-latest` |
| Tool | ShellCheck (latest) |
| Targets | `src/**/*.sh`, `tests/**/*.sh`, `examples/**/*.sh` |
| Config | `.shellcheckrc` |
| Severity | error, warning (no info/style) |

**Expected Output**:
```
Running ShellCheck...
Checking src/test_runner.sh...
Checking src/assertions.sh...
Checking examples/example_test.sh...

✓ All files passed ShellCheck
```

**Failure Output**:
```
In src/test_runner.sh line 45:
  if [ $exit_code -eq 0 ]; then
       ^---------^ SC2086: Double quote to prevent globbing and word splitting.

✗ ShellCheck found 1 issue(s)
```

#### 3.2.2 Test Job (Matrix)

**Purpose**: Run shell-spec self-tests across platform/shell combinations

**Matrix Configuration**:
```yaml
strategy:
  fail-fast: false  # Run all combinations even if one fails
  matrix:
    os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-13]
    shell: [bash, zsh]
    include:
      - os: ubuntu-latest
        shell: sh
      - os: ubuntu-22.04
        shell: sh
    exclude:
      - os: macos-latest
        shell: sh
      - os: macos-13
        shell: sh
```

**Test Execution**:
```bash
# Install shell if needed (zsh on Ubuntu)
# Run tests with specified shell
${{ matrix.shell }} src/test_runner.sh tests/
```

**Expected Output**:
```
Running tests with bash on ubuntu-latest...
Found 15 tests.
Running tests: [====================] 15/15 (100%)

| File                    | Test Function        | Status |
|------------------------|---------------------|--------|
| tests/assertions_test.sh | test_assert_equals  | PASS   |
| tests/assertions_test.sh | test_assert_success | PASS   |
...

--------------------
Test Summary
--------------------
Total tests: 15
Passed: 15
Failed: 0
--------------------
```

#### 3.2.3 Portability Job

**Purpose**: Verify shell-spec works on Alpine Linux with musl libc

**Configuration**:
| Setting | Value |
|---------|-------|
| Container | `alpine:latest` |
| Shell | `/bin/sh` (BusyBox ash) |
| Dependencies | None (uses base Alpine) |

**Rationale**: Alpine uses musl libc instead of glibc, which can expose portability issues in shell scripts that make assumptions about libc behavior.

**Expected Output**:
```
Running portability tests on Alpine Linux...
Shell: /bin/sh (BusyBox ash)
libc: musl

Found 15 tests.
Running tests: [====================] 15/15 (100%)
...
```

### 3.3 Release Workflow

#### 3.3.1 Trigger

```yaml
on:
  push:
    tags:
      - 'v*.*.*'
```

**Examples**: `v0.5.0`, `v1.0.0`, `v1.0.0-beta.1`

#### 3.3.2 Jobs

| Job | Purpose | Depends On |
|-----|---------|------------|
| `validate` | Run full CI suite on tagged commit | - |
| `create-release` | Create GitHub Release | validate |
| `upload-artifacts` | Attach release assets | create-release |

#### 3.3.3 Release Assets

| Asset | Description |
|-------|-------------|
| `shell-spec-vX.Y.Z.tar.gz` | Source archive with version |
| `shell-spec-vX.Y.Z.zip` | Source archive (Windows-friendly) |
| `checksums.txt` | SHA256 checksums for verification |

#### 3.3.4 Release Notes

Auto-generated from:
1. Git tag message (if annotated)
2. Commits since previous tag
3. CHANGELOG.md section (if exists)

### 3.4 ShellCheck Configuration

#### 3.4.1 Configuration File

**File**: `.shellcheckrc`

```bash
# Shell-spec ShellCheck configuration
# https://www.shellcheck.net/wiki/

# Target shell (default for all files)
shell=bash

# Disable specific checks
# SC2034: Variable appears unused (common in test frameworks)
# SC2155: Declare and assign separately (stylistic)
# SC2181: Check exit code directly (stylistic preference)
disable=SC2034,SC2155,SC2181

# Enable optional checks
enable=require-variable-braces

# Severity threshold
# error, warning, info, style
severity=warning
```

#### 3.4.2 Per-File Overrides

For POSIX-compliant files:
```bash
#!/bin/sh
# shellcheck shell=sh
```

For files with intentional patterns:
```bash
# shellcheck disable=SC2086  # Word splitting intentional here
eval "$command"
```

---

## 4. Technical Design

### 4.1 Main CI Workflow: `.github/workflows/ci.yml`

```yaml
# =============================================================================
# ci.yml - Continuous Integration for shell-spec
# =============================================================================
#
# This workflow runs on every push to main and on pull requests.
# It performs:
#   1. Static analysis (ShellCheck)
#   2. Test matrix (multiple OS × shell combinations)
#   3. Portability testing (Alpine Linux)
#
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Lint Job - Static analysis with ShellCheck
  # ===========================================================================
  lint:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.'
          severity: warning
          format: tty
        env:
          SHELLCHECK_OPTS: --rcfile=.shellcheckrc

      - name: Lint summary
        if: always()
        run: |
          echo "## ShellCheck Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ All shell scripts passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ ShellCheck found issues" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Test Job - Matrix testing across OS and shells
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.shell }})
    runs-on: ${{ matrix.os }}
    needs: lint  # Only run if lint passes

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-13]
        shell: [bash, zsh]
        include:
          # Add sh testing for Linux only
          - os: ubuntu-latest
            shell: sh
          - os: ubuntu-22.04
            shell: sh
        exclude:
          # sh (dash) behaves differently on macOS, skip for now
          - os: macos-latest
            shell: sh
          - os: macos-13
            shell: sh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install zsh (Ubuntu)
        if: matrix.shell == 'zsh' && startsWith(matrix.os, 'ubuntu')
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Get shell version
        id: shell-version
        run: |
          case "${{ matrix.shell }}" in
            bash) echo "version=$(${{ matrix.shell }} --version | head -1)" >> $GITHUB_OUTPUT ;;
            zsh)  echo "version=$(${{ matrix.shell }} --version)" >> $GITHUB_OUTPUT ;;
            sh)   echo "version=$(readlink -f /bin/sh) - $(/bin/sh --version 2>&1 | head -1 || echo 'unknown')" >> $GITHUB_OUTPUT ;;
          esac

      - name: Display test environment
        run: |
          echo "## Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.shell-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Run tests
        run: |
          echo "Running shell-spec tests with ${{ matrix.shell }}..."
          ${{ matrix.shell }} src/test_runner.sh
        env:
          SHELL_SPEC_CI: 'true'

      - name: Run tests with TAP output
        if: success() || failure()
        run: |
          echo "Running tests with TAP output..."
          ${{ matrix.shell }} src/test_runner.sh --tap || true

      - name: Test summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Tests passed on ${{ matrix.os }} with ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed on ${{ matrix.os }} with ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Portability Job - Alpine Linux (musl libc)
  # ===========================================================================
  portability:
    name: Portability (Alpine/musl)
    runs-on: ubuntu-latest
    needs: lint
    container:
      image: alpine:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display environment
        run: |
          echo "Shell: $(readlink -f /bin/sh)"
          echo "libc: $(ldd --version 2>&1 | head -1 || echo 'musl')"
          cat /etc/os-release

      - name: Run tests with sh
        run: |
          echo "Running portability tests on Alpine Linux..."
          /bin/sh src/test_runner.sh

      - name: Portability summary
        if: always()
        run: |
          echo "## Portability Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Alpine Linux (musl libc)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: /bin/sh (BusyBox ash)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Portability tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Portability tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Summary Job - Aggregate results
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, portability]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Matrix | ${{ needs.test.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Portability | ${{ needs.portability.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.portability.result }}" != "success" ]; then
            echo ""
            echo "❌ **CI Failed** - See individual job logs for details" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo ""
          echo "✅ **All CI checks passed!**" >> $GITHUB_STEP_SUMMARY
```

### 4.2 Release Workflow: `.github/workflows/release.yml`

```yaml
# =============================================================================
# release.yml - Automated Release for shell-spec
# =============================================================================
#
# This workflow triggers on version tags (v*.*.*) and:
#   1. Validates the release by running full CI
#   2. Creates a GitHub Release
#   3. Uploads release artifacts
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write  # Required for creating releases

jobs:
  # ===========================================================================
  # Validate - Run CI suite on tagged commit
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.'
          severity: warning

      - name: Run tests
        run: bash src/test_runner.sh

      - name: Run portability test
        run: |
          docker run --rm -v "$PWD":/app -w /app alpine:latest \
            /bin/sh src/test_runner.sh

  # ===========================================================================
  # Create Release - Build and publish GitHub Release
  # ===========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ steps.get_version.outputs.version }}"
            CHANGES=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            echo "First release - including all commits"
            CHANGES=$(git log --pretty=format:"- %s (%h)")
          fi

          # Write to file for multiline handling
          echo "$CHANGES" > /tmp/changelog.txt
          echo "changelog_file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: shell-spec ${{ steps.get_version.outputs.version }}
          body: |
            ## What's Changed

            $(cat ${{ steps.changelog.outputs.changelog_file }})

            ## Installation

            ```bash
            # Clone and install
            git clone https://github.com/${{ github.repository }}.git
            cd shell-spec

            # Or download this release
            curl -L https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.version }}.tar.gz | tar xz
            ```

            ## Checksums

            See `checksums.txt` in release assets.
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Upload Artifacts - Attach release assets
  # ===========================================================================
  upload-artifacts:
    name: Upload Artifacts
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create release archives
        run: |
          VERSION=${{ needs.create-release.outputs.version }}

          # Create tar.gz archive
          tar -czvf shell-spec-${VERSION}.tar.gz \
            --transform "s,^,shell-spec-${VERSION}/," \
            src/ examples/ README.md LICENSE

          # Create zip archive
          mkdir -p shell-spec-${VERSION}
          cp -r src/ examples/ README.md LICENSE shell-spec-${VERSION}/
          zip -r shell-spec-${VERSION}.zip shell-spec-${VERSION}
          rm -rf shell-spec-${VERSION}

          # Generate checksums
          sha256sum shell-spec-${VERSION}.tar.gz shell-spec-${VERSION}.zip > checksums.txt

          echo "Created release archives:"
          ls -la shell-spec-${VERSION}.*
          cat checksums.txt

      - name: Upload tar.gz
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: shell-spec-${{ needs.create-release.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload zip
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: shell-spec-${{ needs.create-release.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Assets**:" >> $GITHUB_STEP_SUMMARY
          echo "- shell-spec-${{ needs.create-release.outputs.version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- shell-spec-${{ needs.create-release.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- checksums.txt" >> $GITHUB_STEP_SUMMARY
```

### 4.3 ShellCheck Configuration: `.shellcheckrc`

```bash
# =============================================================================
# .shellcheckrc - ShellCheck configuration for shell-spec
# =============================================================================
#
# ShellCheck is a static analysis tool for shell scripts.
# https://www.shellcheck.net/
#
# This configuration is applied to all .sh files in the repository.
# Per-file overrides can be added with inline directives:
#   # shellcheck disable=SC2086
#
# =============================================================================

# Default shell dialect
# Options: sh, bash, dash, ksh
# shell-spec primarily targets bash, but aims for broad compatibility
shell=bash

# Minimum severity to report
# Options: error, warning, info, style
severity=warning

# Disabled checks
# ─────────────────────────────────────────────────────────────────────────────
# SC2034 - Variable appears unused
#   Reason: Test frameworks often define variables for later assertion
#   Example: expected="foo"; assert_equals "$expected" "$actual"
#
# SC2155 - Declare and assign separately to avoid masking return values
#   Reason: Stylistic preference; our assignments don't need return values
#   Example: local result=$(some_function)
#
# SC2181 - Check exit code directly with 'if cmd;', not indirectly with $?
#   Reason: We often capture $? for multiple uses or readable comparisons
#   Example: cmd; exit_code=$?; if [ $exit_code -eq 0 ]; ...
#
# SC1090 - Can't follow non-constant source
#   Reason: Dynamic sourcing is intentional in test framework
#   Example: source "$SCRIPT_DIR/assertions.sh"
#
# SC1091 - Not following sourced file (file not found)
#   Reason: CI may not have all files in expected locations
#
disable=SC2034,SC2155,SC2181,SC1090,SC1091

# Enabled optional checks
# ─────────────────────────────────────────────────────────────────────────────
# require-variable-braces - Require ${var} instead of $var
#   Reason: Improves readability and prevents ambiguity
#
enable=require-variable-braces

# External sources
# Allow shellcheck to follow source directives
external-sources=true

# Source path for finding sourced files
# source-path=src:tests:examples
```

---

## 5. Workflows

### 5.1 Pull Request Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Developer opens Pull Request to main                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. GitHub triggers ci.yml                                                    │
│    • Event: pull_request                                                    │
│    • Target: main branch                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Lint job runs first                                                       │
│    • ShellCheck analyzes all .sh files                                      │
│    • Uses .shellcheckrc configuration                                       │
│    • Fails PR if errors found                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ Lint passes?                      │
                    │                                   │
               ┌────┴────┐                         ┌────┴────┐
               │   Yes   │                         │   No    │
               └────┬────┘                         └────┬────┘
                    │                                   │
                    ▼                                   ▼
┌─────────────────────────────┐           ┌─────────────────────────────┐
│ 3. Test matrix (parallel)   │           │ CI fails immediately        │
│    • 10 OS/shell combos     │           │ • PR cannot be merged       │
│    • All run simultaneously │           │ • Developer fixes issues    │
└─────────────────────────────┘           └─────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Portability job (parallel with test matrix)                               │
│    • Alpine Linux container                                                 │
│    • Tests with /bin/sh (BusyBox)                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. CI Status job aggregates results                                          │
│    • Checks all job statuses                                                │
│    • Writes summary to PR                                                   │
│    • Sets overall pass/fail                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ All jobs pass?                    │
                    │                                   │
               ┌────┴────┐                         ┌────┴────┐
               │   Yes   │                         │   No    │
               └────┬────┘                         └────┬────┘
                    │                                   │
                    ▼                                   ▼
┌─────────────────────────────┐           ┌─────────────────────────────┐
│ PR ready for review         │           │ PR blocked                  │
│ • Green checkmark           │           │ • Red X on PR               │
│ • Can be merged             │           │ • Details in Actions tab    │
└─────────────────────────────┘           └─────────────────────────────┘
```

### 5.2 Release Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Maintainer pushes version tag                              │
│                   git tag v0.5.0 && git push origin v0.5.0                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. GitHub triggers release.yml                                               │
│    • Event: push (tag)                                                      │
│    • Tag pattern: v*.*.*                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Validate job                                                              │
│    • Run ShellCheck                                                         │
│    • Run tests on ubuntu-latest                                             │
│    • Run Alpine portability test                                            │
│    • MUST PASS before release created                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ Validation passes?                │
                    │                                   │
               ┌────┴────┐                         ┌────┴────┐
               │   Yes   │                         │   No    │
               └────┬────┘                         └────┬────┘
                    │                                   │
                    ▼                                   ▼
┌─────────────────────────────┐           ┌─────────────────────────────┐
│ 3. Create Release job       │           │ Release aborted             │
│    • Extract version        │           │ • Tag exists but no release │
│    • Generate changelog     │           │ • Fix issues, delete tag    │
│    • Create GitHub Release  │           │ • Re-tag after fix          │
└─────────────────────────────┘           └─────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Upload Artifacts job                                                      │
│    • Create .tar.gz archive                                                 │
│    • Create .zip archive                                                    │
│    • Generate SHA256 checksums                                              │
│    • Attach all to GitHub Release                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. Release published                                                         │
│    • Visible on Releases page                                               │
│    • Download links available                                               │
│    • Changelog auto-generated                                               │
│    • Pre-release flag if version contains '-'                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Local Development Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   Developer makes local changes                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. Run ShellCheck locally (optional but recommended)                         │
│                                                                             │
│    $ shellcheck src/*.sh                                                    │
│    # or with config:                                                        │
│    $ shellcheck --rcfile=.shellcheckrc src/*.sh                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Run tests locally                                                         │
│                                                                             │
│    $ bash src/test_runner.sh                    # Default                   │
│    $ bash src/test_runner.sh tests/             # Specific directory        │
│    $ zsh src/test_runner.sh                     # Test with zsh             │
│    $ sh src/test_runner.sh                      # Test with sh              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Test portability with Docker (optional)                                   │
│                                                                             │
│    $ docker run --rm -v "$PWD":/app -w /app alpine:latest \                │
│        /bin/sh src/test_runner.sh                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Commit and push                                                           │
│    • CI runs automatically on push/PR                                       │
│    • Same checks as local, but official                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Use Cases

### 6.1 UC-01: Pull Request Validation

**Actor**: Contributor submitting code changes
**Goal**: Verify changes don't break existing functionality

**Scenario**:
```
1. Developer forks repository
2. Makes changes to src/assertions.sh
3. Opens PR to main branch
4. CI automatically runs:
   - ShellCheck finds no issues
   - Tests pass on all 10 matrix combinations
   - Alpine portability test passes
5. PR shows green checkmark
6. Maintainer reviews and merges
```

**Expected CI Output**:
```
CI Summary

| Job | Status |
|-----|--------|
| Lint | ✅ |
| Test Matrix | ✅ |
| Portability | ✅ |

✅ All CI checks passed!
```

### 6.2 UC-02: ShellCheck Catches Bug

**Actor**: Developer introducing shell syntax error
**Goal**: Prevent buggy code from being merged

**Scenario**:
```bash
# Developer adds code with unquoted variable:
if [ $result = "success" ]; then
    echo "OK"
fi
```

**CI Response**:
```
In src/test_runner.sh line 145:
  if [ $result = "success" ]; then
       ^-----^ SC2086: Double quote to prevent globbing and word splitting.

For more information:
  https://www.shellcheck.net/wiki/SC2086

❌ ShellCheck found 1 issue(s)
```

**Resolution**:
```bash
# Developer fixes:
if [ "$result" = "success" ]; then
    echo "OK"
fi
```

### 6.3 UC-03: Cross-Platform Failure Detection

**Actor**: Developer using bash-specific feature
**Goal**: Catch platform-specific bugs before merge

**Scenario**:
```bash
# Developer adds bash-specific code:
if [[ $output =~ ^[0-9]+$ ]]; then
    echo "Is a number"
fi
```

**CI Results**:
```
| Platform | Shell | Status |
|----------|-------|--------|
| ubuntu-latest | bash | ✅ |
| ubuntu-latest | zsh | ✅ |
| ubuntu-latest | sh | ❌ |
| macos-latest | bash | ✅ |
| Alpine | sh | ❌ |
```

**Failure Message**:
```
Running tests with sh on ubuntu-latest...
src/test_runner.sh: line 145: syntax error: unexpected "("
```

### 6.4 UC-04: Creating a New Release

**Actor**: Maintainer releasing new version
**Goal**: Publish release with artifacts

**Scenario**:
```bash
# 1. Update version references (manual)
# 2. Commit changes
git commit -am "Prepare v0.5.0 release"

# 3. Create and push tag
git tag -a v0.5.0 -m "Release v0.5.0 - CI/CD Integration"
git push origin v0.5.0
```

**CI Response**:
```
Release workflow triggered for v0.5.0

Jobs:
1. ✅ Validate - All tests passed
2. ✅ Create Release - GitHub Release created
3. ✅ Upload Artifacts - 3 files attached

Release Published:
- shell-spec-v0.5.0.tar.gz (15 KB)
- shell-spec-v0.5.0.zip (18 KB)
- checksums.txt (256 bytes)
```

### 6.5 UC-05: Pre-release Version

**Actor**: Maintainer releasing beta version
**Goal**: Publish pre-release for testing

**Scenario**:
```bash
git tag v1.0.0-beta.1
git push origin v1.0.0-beta.1
```

**CI Behavior**:
- Detects `-` in version string
- Creates release with `prerelease: true`
- Shows "Pre-release" badge on GitHub

### 6.6 UC-06: Manual CI Trigger with Debug

**Actor**: Developer debugging CI failures
**Goal**: Run CI with verbose logging

**Steps**:
1. Go to Actions tab on GitHub
2. Select "CI" workflow
3. Click "Run workflow"
4. Enable "debug_enabled" checkbox
5. Click "Run workflow"

**Result**: CI runs with additional diagnostic output for troubleshooting.

---

## 7. Decision Trees

### 7.1 Shell Selection Decision

```
                    ┌─────────────────────────────┐
                    │  Which shell to test?       │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Operating System?         │
                    └─────────────┬─────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │                     │                     │
            ▼                     ▼                     ▼
    ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
    │    Ubuntu     │     │    macOS      │     │    Alpine     │
    └───────┬───────┘     └───────┬───────┘     └───────┬───────┘
            │                     │                     │
            ▼                     ▼                     ▼
    ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
    │ bash, zsh, sh │     │   bash, zsh   │     │      sh       │
    │   (3 shells)  │     │   (2 shells)  │     │   (1 shell)   │
    └───────────────┘     └───────────────┘     └───────────────┘

    Note: sh excluded from macOS because dash behavior differs
          significantly and is rarely used in practice on macOS.
```

### 7.2 Release Type Decision

```
                    ┌─────────────────────────────┐
                    │  Tag pushed: v*.*.*         │
                    └─────────────┬───────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │  Does version contain '-'?  │
                    │  (e.g., v1.0.0-beta.1)     │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ No                        │ Yes
                    ▼                           ▼
          ┌─────────────────┐         ┌─────────────────┐
          │ Stable Release  │         │ Pre-release     │
          │                 │         │                 │
          │ prerelease:     │         │ prerelease:     │
          │ false           │         │ true            │
          │                 │         │                 │
          │ Shows as        │         │ Shows as        │
          │ "Latest"        │         │ "Pre-release"   │
          └─────────────────┘         └─────────────────┘
```

### 7.3 CI Failure Handling

```
                    ┌─────────────────────────────┐
                    │  CI job fails               │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Which job failed?         │
                    └─────────────┬─────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│     Lint      │         │     Test      │         │  Portability  │
└───────┬───────┘         └───────┬───────┘         └───────┬───────┘
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│ ShellCheck    │         │ Check which   │         │ Alpine/musl   │
│ error         │         │ matrix cell   │         │ incompatible  │
│               │         │ failed        │         │               │
│ Action:       │         │               │         │ Action:       │
│ Fix syntax    │         │ Action:       │         │ Check for     │
│ per SC code   │         │ Fix shell-    │         │ POSIX compat  │
└───────────────┘         │ specific bug  │         └───────────────┘
                          └───────────────┘
```

---

## 8. Logging & Diagnostics

### 8.1 CI Output Messages

| Event | Message | Location |
|-------|---------|----------|
| CI Start | `Running CI for commit abc123...` | Job log |
| Lint Pass | `✅ All shell scripts passed linting` | Summary |
| Lint Fail | `❌ ShellCheck found N issue(s)` | Summary |
| Test Start | `Running shell-spec tests with bash...` | Job log |
| Test Pass | `✅ Tests passed on ubuntu-latest with bash` | Summary |
| Test Fail | `❌ Tests failed on ubuntu-latest with bash` | Summary |
| Portability Pass | `✅ Portability tests passed` | Summary |
| Portability Fail | `❌ Portability tests failed` | Summary |
| Release Created | `Release v0.5.0 published` | Summary |

### 8.2 GitHub Actions Summary Format

```markdown
## CI Summary

| Job | Status |
|-----|--------|
| Lint | ✅ |
| Test Matrix | ✅ |
| Portability | ✅ |

✅ **All CI checks passed!**

### Test Matrix Results

| OS | bash | zsh | sh |
|----|------|-----|-----|
| ubuntu-latest | ✅ | ✅ | ✅ |
| ubuntu-22.04 | ✅ | ✅ | ✅ |
| macos-latest | ✅ | ✅ | - |
| macos-13 | ✅ | ✅ | - |
| Alpine | - | - | ✅ |

### Environment Details

- **Runner**: ubuntu-latest
- **Shell versions**:
  - bash: GNU bash, version 5.1.16
  - zsh: zsh 5.8.1
  - sh: dash 0.5.11
```

### 8.3 Debug Mode Output

When `debug_enabled: true`:

```
::debug::Starting CI workflow
::debug::Workflow triggered by: pull_request
::debug::Commit SHA: abc123def456
::debug::Branch: feature/new-assertion
::debug::
::debug::Matrix configuration:
::debug::  - ubuntu-latest + bash
::debug::  - ubuntu-latest + zsh
::debug::  - ubuntu-latest + sh
::debug::  ...
::debug::
::debug::ShellCheck version: 0.9.0
::debug::Scanning files:
::debug::  - src/test_runner.sh
::debug::  - src/assertions.sh
::debug::  - examples/example_test.sh
```

### 8.4 Error Diagnostics

**ShellCheck Error Format**:
```
In src/test_runner.sh line 45:
  if [ $exit_code -eq 0 ]; then
       ^---------^ SC2086 (info): Double quote to prevent globbing.

Did you mean:
  if [ "$exit_code" -eq 0 ]; then

For more information:
  https://www.shellcheck.net/wiki/SC2086
```

**Test Failure Format**:
```
FAIL: test_assert_equals in tests/assertions_test.sh
  Expected: "hello"
  Actual:   "world"

  Test function output:
  Assertion failed: values are not equal
```

---

## 9. Documentation Requirements

### 9.1 Inline Documentation

#### 9.1.1 Workflow File Headers

```yaml
# =============================================================================
# ci.yml - Continuous Integration for shell-spec
# =============================================================================
#
# This workflow runs on every push to main and on pull requests.
# It performs:
#   1. Static analysis (ShellCheck)
#   2. Test matrix (multiple OS × shell combinations)
#   3. Portability testing (Alpine Linux)
#
# Matrix combinations:
#   - Ubuntu (latest, 22.04) × (bash, zsh, sh) = 6 jobs
#   - macOS (latest, 13) × (bash, zsh) = 4 jobs
#   - Alpine Linux × sh = 1 job
#   Total: 11 jobs + 1 summary job
#
# Triggers:
#   - push: main branch
#   - pull_request: to main branch
#   - workflow_dispatch: manual with optional debug
#
# =============================================================================
```

### 9.2 README.md Updates

```markdown
## CI/CD Status

[![CI](https://github.com/<user>/shell-spec/actions/workflows/ci.yml/badge.svg)](https://github.com/<user>/shell-spec/actions/workflows/ci.yml)

### Test Matrix

shell-spec is tested across multiple platforms and shells:

| Platform | bash | zsh | sh |
|----------|------|-----|-----|
| Ubuntu (latest) | ✓ | ✓ | ✓ |
| Ubuntu 22.04 | ✓ | ✓ | ✓ |
| macOS (latest) | ✓ | ✓ | - |
| macOS 13 | ✓ | ✓ | - |
| Alpine Linux | - | - | ✓ |

### Running CI Locally

```bash
# Lint with ShellCheck
shellcheck --rcfile=.shellcheckrc src/*.sh

# Run tests
bash src/test_runner.sh

# Test portability with Docker
docker run --rm -v "$PWD":/app -w /app alpine:latest /bin/sh src/test_runner.sh
```

### Creating a Release

1. Ensure all CI checks pass on main
2. Update CHANGELOG.md with release notes
3. Create and push a version tag:
   ```bash
   git tag -a v0.5.0 -m "Release v0.5.0"
   git push origin v0.5.0
   ```
4. GitHub Actions will automatically create the release
```

### 9.3 Changelog Entry

```markdown
## [0.5.0] - YYYY-MM-DD

### Added
- GitHub Actions CI workflow (`.github/workflows/ci.yml`)
  - Multi-platform testing (Ubuntu, macOS)
  - Multi-shell testing (bash, zsh, sh)
  - ShellCheck static analysis
  - Alpine Linux portability testing
- GitHub Actions release workflow (`.github/workflows/release.yml`)
  - Automatic release creation on version tags
  - Release artifact generation (tar.gz, zip)
  - SHA256 checksum generation
- ShellCheck configuration (`.shellcheckrc`)
  - Project-specific lint rules
  - Disabled checks for test framework patterns

### Changed
- README updated with CI status badge
- README updated with test matrix documentation

### Notes
- CI runs on every push to main and pull requests
- Releases are created automatically when pushing `v*.*.*` tags
- Pre-release versions (containing `-`) are marked as pre-release on GitHub
```

---

## 10. Deliverables Checklist

### 10.1 Workflow Files

- [ ] **`.github/workflows/ci.yml`** (new file, ~100 lines)
  - [ ] Workflow name and trigger configuration
  - [ ] Concurrency settings
  - [ ] Lint job with ShellCheck
  - [ ] Test job with matrix strategy
  - [ ] Portability job with Alpine container
  - [ ] CI status aggregation job
  - [ ] GitHub Step Summary output

- [ ] **`.github/workflows/release.yml`** (new file, ~120 lines)
  - [ ] Tag trigger configuration
  - [ ] Validate job (lint + test + portability)
  - [ ] Create release job
  - [ ] Upload artifacts job
  - [ ] Changelog generation
  - [ ] Pre-release detection

### 10.2 Configuration Files

- [ ] **`.shellcheckrc`** (new file, ~10 lines)
  - [ ] Default shell setting
  - [ ] Disabled check codes with rationale
  - [ ] Enabled optional checks
  - [ ] Severity threshold

### 10.3 Self-Tests (if not existing)

- [ ] **`tests/assertions_test.sh`** (verify exists or create)
  - [ ] Tests for all assertion functions
  - [ ] Edge case testing

- [ ] **`tests/runner_test.sh`** (verify exists or create)
  - [ ] Test runner behavior tests
  - [ ] Argument parsing tests

### 10.4 Documentation Updates

- [ ] **`README.md`** updates
  - [ ] CI status badge
  - [ ] Test matrix table
  - [ ] Local CI commands
  - [ ] Release instructions

- [ ] **`CHANGELOG.md`** entry
  - [ ] v0.5.0 release notes

### 10.5 Validation Tasks

- [ ] CI workflow runs successfully on push
- [ ] CI workflow runs successfully on PR
- [ ] All matrix combinations pass
- [ ] ShellCheck passes with configuration
- [ ] Alpine portability test passes
- [ ] Release workflow creates release on tag
- [ ] Release artifacts are attached correctly
- [ ] Pre-release versions detected correctly
- [ ] CI badge shows correct status

---

## 11. Testing Strategy

### 11.1 Workflow Validation Tests

**Test: CI triggers on push to main**
```bash
# Push a commit to main
git commit --allow-empty -m "Test CI trigger"
git push origin main

# Verify: CI workflow starts within 30 seconds
# Verify: All jobs appear in Actions tab
```

**Test: CI triggers on pull request**
```bash
# Create PR to main
git checkout -b test-pr
git commit --allow-empty -m "Test PR trigger"
git push origin test-pr
# Open PR via GitHub UI

# Verify: CI workflow starts automatically
# Verify: PR shows "checks pending" then "checks passed"
```

**Test: Release triggers on tag**
```bash
# Create test tag
git tag v0.0.0-test
git push origin v0.0.0-test

# Verify: Release workflow starts
# Verify: Release created with pre-release flag
# Verify: Artifacts attached

# Cleanup
git push origin --delete v0.0.0-test
# Delete release via GitHub UI
```

### 11.2 Matrix Coverage Tests

**Test: All shells execute correctly**
```bash
# Local testing of each shell
bash src/test_runner.sh tests/
zsh src/test_runner.sh tests/
sh src/test_runner.sh tests/  # May fail on advanced features

# Each should complete without syntax errors
```

**Test: Alpine portability**
```bash
# Run in Alpine container
docker run --rm -v "$PWD":/app -w /app alpine:latest \
    /bin/sh src/test_runner.sh

# Should complete without errors (basic functionality)
```

### 11.3 ShellCheck Tests

**Test: All files pass lint**
```bash
# Run ShellCheck with project config
shellcheck --rcfile=.shellcheckrc src/*.sh examples/*.sh

# Should exit with code 0
echo $?  # Expected: 0
```

**Test: Disabled checks don't trigger**
```bash
# Create file with disabled pattern
echo 'local result=$(cmd)' > /tmp/test.sh
shellcheck --rcfile=.shellcheckrc /tmp/test.sh

# SC2155 should not trigger (disabled in config)
```

### 11.4 Release Artifact Tests

**Test: Archives contain correct files**
```bash
# After release, download and verify
tar -tzf shell-spec-v0.5.0.tar.gz | sort
# Expected:
# shell-spec-v0.5.0/LICENSE
# shell-spec-v0.5.0/README.md
# shell-spec-v0.5.0/examples/example_test.sh
# shell-spec-v0.5.0/src/assertions.sh
# shell-spec-v0.5.0/src/test_runner.sh
```

**Test: Checksums are valid**
```bash
# Download checksums.txt and archives
sha256sum -c checksums.txt
# Expected: shell-spec-v0.5.0.tar.gz: OK
#           shell-spec-v0.5.0.zip: OK
```

---

## 12. Acceptance Criteria

### 12.1 Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-01 | CI runs on push to main | Push commit, verify workflow runs |
| AC-02 | CI runs on pull request | Open PR, verify workflow runs |
| AC-03 | Lint job uses ShellCheck | Check job logs for ShellCheck output |
| AC-04 | Test matrix covers all combinations | Verify 10 test jobs run |
| AC-05 | Portability job uses Alpine | Check container image in logs |
| AC-06 | Release triggers on version tag | Push tag, verify release workflow |
| AC-07 | Release artifacts attached | Check release page for files |
| AC-08 | Pre-release detected correctly | Tag with `-`, verify pre-release flag |

### 12.2 Configuration Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| CC-01 | `.shellcheckrc` configures default shell | Check `shell=bash` in file |
| CC-02 | Disabled checks documented | Comments explain each SC code |
| CC-03 | Concurrency prevents duplicate runs | Push twice rapidly, verify one canceled |
| CC-04 | fail-fast disabled on matrix | One failure doesn't stop others |

### 12.3 Output Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| OC-01 | CI Summary shows all job statuses | Check GitHub Actions summary |
| OC-02 | Matrix shows shell versions | Check summary for version info |
| OC-03 | Lint errors show file and line | Introduce error, check output |
| OC-04 | Release notes include changelog | Check release body text |

### 12.4 Performance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| PC-01 | CI completes in < 10 minutes | Check workflow duration |
| PC-02 | Lint job completes in < 1 minute | Check job duration |
| PC-03 | Individual test jobs < 2 minutes | Check matrix job durations |

### 12.5 Error Handling Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| EH-01 | Lint failure blocks test jobs | Introduce lint error, verify test skipped |
| EH-02 | Matrix failure doesn't fail all | One shell fails, others complete |
| EH-03 | Release aborted if validation fails | Introduce test failure, verify no release |
| EH-04 | Clear error messages in logs | Check failure output is actionable |

---

## Appendix A: Shell Compatibility Notes

### A.1 Bash-Specific Features

| Feature | Used In | POSIX Alternative |
|---------|---------|-------------------|
| `[[ ]]` | test_runner.sh | `[ ]` with careful quoting |
| `local` | assertions.sh | Function-scoped vars (some shells) |
| `declare -a` | mocking.sh | Not available |
| `declare -A` | coverage.sh | Not available |
| `trap DEBUG` | coverage.sh | Not available |

### A.2 Shell Testing Strategy

```
Feature Compatibility by Shell:
                    bash    zsh     sh
─────────────────────────────────────────
Core (v0.1.0)       ✓       ✓       ~
TAP (v0.2.0)        ✓       ✓       ✓
Mocking (v0.3.0)    ✓       ~       ✗
Coverage (v0.4.0)   ✓       ✗       ✗

Legend:
  ✓ = Full support
  ~ = Partial support (may need adjustments)
  ✗ = Not supported
```

### A.3 CI Matrix Rationale

**Why exclude sh on macOS?**
- macOS ships with `/bin/sh` linked to `/bin/bash` in legacy mode
- Behavior differs significantly from Linux's dash
- Testing provides minimal additional coverage
- Could cause false positives/negatives

**Why include Alpine specifically?**
- Uses BusyBox ash (different from dash)
- Uses musl libc (different from glibc)
- Common in containerized environments
- Excellent portability stress test

---

## Appendix B: GitHub Actions Reference

### B.1 Useful Actions

| Action | Version | Purpose |
|--------|---------|---------|
| `actions/checkout` | v4 | Check out repository |
| `ludeeus/action-shellcheck` | 2.0.0 | Run ShellCheck |
| `softprops/action-gh-release` | v1 | Create GitHub releases |

### B.2 Matrix Syntax Reference

```yaml
strategy:
  fail-fast: false  # Don't cancel other jobs on failure
  matrix:
    os: [ubuntu-latest, macos-latest]
    shell: [bash, zsh]
    include:  # Add specific combinations
      - os: ubuntu-latest
        shell: sh
    exclude:  # Remove specific combinations
      - os: macos-latest
        shell: sh
```

### B.3 Concurrency Reference

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

- Groups runs by workflow + branch
- Cancels older runs when new one starts
- Prevents resource waste on rapid pushes

---

## Appendix C: Troubleshooting Guide

### C.1 CI Not Triggering

**Symptoms**: Push or PR doesn't start workflow

**Possible Causes**:
1. Workflow file syntax error
2. Wrong branch name in trigger
3. Workflow file not in default branch

**Solutions**:
1. Validate YAML syntax
2. Check branch names match exactly
3. Merge workflow to main first

### C.2 Matrix Job Failures

**Symptoms**: Some matrix combinations fail, others pass

**Possible Causes**:
1. Shell-specific syntax error
2. Missing shell on runner
3. Platform-specific behavior

**Solutions**:
1. Check failing shell's error message
2. Verify shell installation step runs
3. Add platform checks in code

### C.3 Release Not Created

**Symptoms**: Tag pushed but no release appears

**Possible Causes**:
1. Validation job failed
2. Tag format doesn't match pattern
3. GitHub token permissions issue

**Solutions**:
1. Check workflow run for errors
2. Verify tag matches `v*.*.*` pattern
3. Check repository settings for Actions permissions

---

*Document Version: 1.0*
*Last Updated: 2025-01-04*
*Status: Specification Complete - Ready for Implementation*
