# Shell-Spec v0.6.0 Specification: Package Distribution

## Overview

**Version**: 0.6.0
**Feature**: Package Distribution
**Status**: Planned
**Complexity**: Medium
**Estimated Lines of Code**: ~170 (new files only)
**Dependencies**: v0.5.0 (CI/CD Integration) should be complete first
**Compatibility**: All platforms (Linux, macOS); All shells (bash, zsh, sh)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Architecture](#2-architecture)
3. [Functional Specification](#3-functional-specification)
4. [Technical Design](#4-technical-design)
5. [Workflows](#5-workflows)
6. [Use Cases](#6-use-cases)
7. [Decision Trees](#7-decision-trees)
8. [Logging & Diagnostics](#8-logging--diagnostics)
9. [Documentation Requirements](#9-documentation-requirements)
10. [Deliverables Checklist](#10-deliverables-checklist)
11. [Testing Strategy](#11-testing-strategy)
12. [Acceptance Criteria](#12-acceptance-criteria)

---

## 1. Executive Summary

### 1.1 Purpose

Enable easy installation of shell-spec via multiple distribution methods, transforming the project from a clone-and-run repository into a properly packaged tool that can be installed globally and invoked from anywhere. This removes friction for new users and enables shell-spec to be integrated into developer toolchains and CI environments seamlessly.

### 1.2 Goals

- npm package for cross-platform JavaScript ecosystem distribution
- Homebrew formula for macOS native package management
- Universal curl installer for quick bootstrap installation
- Makefile for traditional Unix-style local installation
- Version tracking via VERSION file with `--version` flag support
- CHANGELOG.md for release notes and upgrade guidance
- Semantic versioning enforcement across all distribution channels

### 1.3 Non-Goals

- Package manager support beyond npm/Homebrew (apt, yum, pacman deferred)
- Windows native installer (.msi, .exe)
- Docker image distribution (users can build their own)
- GUI installer applications
- Auto-update functionality
- License key or registration systems

### 1.4 Key Constraints

- Must not introduce runtime dependencies beyond bash/sh
- npm package must work without Node.js runtime for test execution
- Install paths must follow platform conventions (/usr/local/bin on Unix)
- All installation methods must result in identical functionality
- Uninstallation must be clean with no orphaned files
- Must maintain backward compatibility with direct script invocation

---

## 2. Architecture

### 2.1 Distribution Channel Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        shell-spec Distribution Channels                      │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   GitHub Repo   │
                              │  (Source of     │
                              │   Truth)        │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│     npm Registry    │   │   Homebrew Tap      │   │   GitHub Releases   │
│                     │   │                     │   │                     │
│  npm install -g     │   │  brew install       │   │  curl installer     │
│  shell-spec         │   │  <user>/tap/        │   │  or manual download │
│                     │   │  shell-spec         │   │                     │
└──────────┬──────────┘   └──────────┬──────────┘   └──────────┬──────────┘
           │                         │                         │
           │                         │                         │
           ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           User's System                                      │
│                                                                             │
│  Installation Target: /usr/local/bin/shell-spec (symlink or script)        │
│  Library Location:    /usr/local/lib/shell-spec/ (source files)            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Installed Files                              │   │
│  │                                                                      │   │
│  │  /usr/local/bin/                                                    │   │
│  │  └── shell-spec          # CLI entry point (executable)            │   │
│  │                                                                      │   │
│  │  /usr/local/lib/shell-spec/                                         │   │
│  │  ├── test_runner.sh      # Main test executor                       │   │
│  │  ├── assertions.sh       # Assertion library                        │   │
│  │  ├── report_template.html # HTML report template                    │   │
│  │  └── VERSION             # Version file                             │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Usage:                                                                     │
│  $ shell-spec                    # Run tests in current directory          │
│  $ shell-spec --version          # Show version                            │
│  $ shell-spec --help             # Show help                               │
│  $ shell-spec tests/             # Run tests in specific directory         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 File Structure

```
shell-spec/
├── bin/
│   └── shell-spec              # NEW: CLI wrapper script (~15 lines)
├── src/
│   ├── test_runner.sh          # MODIFIED: Add --version support
│   ├── assertions.sh           # NO CHANGE
│   ├── report_template.html    # NO CHANGE
│   └── ...                     # Other source files unchanged
├── package.json                # NEW: npm package configuration (~40 lines)
├── VERSION                     # NEW: Version tracking file (1 line)
├── CHANGELOG.md                # NEW: Release notes (~100 lines initial)
├── install.sh                  # NEW: Universal installer script (~80 lines)
├── Makefile                    # NEW: Build/install targets (~50 lines)
├── README.md                   # MODIFIED: Installation instructions
├── LICENSE                     # NO CHANGE
└── ...
```

### 2.3 Version Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Version Management Flow                            │
└─────────────────────────────────────────────────────────────────────────────┘

  Developer Updates Version
           │
           ▼
┌─────────────────────┐
│   Edit VERSION      │     Contains: 0.6.0
│   file              │     (single line, no prefix)
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Update CHANGELOG   │     Add release notes for new version
│  (manual)           │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Update package.json│     "version": "0.6.0"
│  (manual or script) │     Must match VERSION file
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  git commit & tag   │     git tag v0.6.0
│                     │     git push origin v0.6.0
└──────────┬──────────┘
           │
           ├───────────────────────────────────────┐
           │                                       │
           ▼                                       ▼
┌─────────────────────┐               ┌─────────────────────┐
│  GitHub Actions     │               │  npm publish        │
│  Release Workflow   │               │  (via CI)           │
│  (from v0.5.0)      │               │                     │
└──────────┬──────────┘               └──────────┬──────────┘
           │                                     │
           ▼                                     ▼
┌─────────────────────┐               ┌─────────────────────┐
│  GitHub Release     │               │  npm Registry       │
│  with assets        │               │  shell-spec@0.6.0   │
└─────────────────────┘               └─────────────────────┘
```

### 2.4 Installation Method Comparison

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Installation Method Comparison Matrix                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┬────────────┬────────────┬────────────┬────────────┬─────────┐
│    Method    │  Primary   │   Ease of  │   Update   │  Uninstall │  Sudo   │
│              │  Audience  │   Install  │   Method   │   Method   │Required │
├──────────────┼────────────┼────────────┼────────────┼────────────┼─────────┤
│ npm          │ JS/Node    │ ★★★★★     │ npm update │npm uninstall│  No*   │
│              │ developers │            │            │            │         │
├──────────────┼────────────┼────────────┼────────────┼────────────┼─────────┤
│ Homebrew     │ macOS      │ ★★★★★     │brew upgrade│brew uninstall│  No    │
│              │ users      │            │            │            │         │
├──────────────┼────────────┼────────────┼────────────┼────────────┼─────────┤
│ curl install │ Quick      │ ★★★★☆     │ Re-run     │ make       │ Yes**  │
│              │ bootstrap  │            │ installer  │ uninstall  │         │
├──────────────┼────────────┼────────────┼────────────┼────────────┼─────────┤
│ make install │ Unix       │ ★★★☆☆     │ git pull   │ make       │ Yes**  │
│              │ traditionl │            │ + reinstall│ uninstall  │         │
├──────────────┼────────────┼────────────┼────────────┼────────────┼─────────┤
│ Direct use   │ Existing   │ ★★☆☆☆     │ git pull   │ rm -rf     │  No    │
│ (git clone)  │ users      │            │            │            │         │
└──────────────┴────────────┴────────────┴────────────┴────────────┴─────────┘

*  npm -g may require sudo depending on Node.js installation
** Can install to ~/.local/bin without sudo using PREFIX=~/.local
```

---

## 3. Functional Specification

### 3.1 CLI Interface Changes

#### 3.1.1 New Command-Line Options

| Flag | Short | Description | Example |
|------|-------|-------------|---------|
| `--version` | `-v` | Print version and exit | `shell-spec --version` |
| `--help` | `-h` | Print help message and exit | `shell-spec --help` |

#### 3.1.2 Version Output Format

```bash
$ shell-spec --version
shell-spec 0.6.0

$ shell-spec -v
shell-spec 0.6.0
```

**Notes:**
- No "v" prefix in output (e.g., "0.6.0" not "v0.6.0")
- Single line output for easy parsing
- Exit code 0 on success

#### 3.1.3 Help Output Format

```bash
$ shell-spec --help
shell-spec - A lightweight shell script testing framework

Usage: shell-spec [OPTIONS] [PATTERN] [DIRECTORY]

Options:
  -h, --help         Show this help message and exit
  -v, --version      Show version number and exit
  --html <file>      Generate HTML report to specified file
  --verbose          Enable verbose output
  --watch            Enable watch mode for continuous testing
  --tap              Output in TAP format

Arguments:
  PATTERN            Test file pattern (default: *_test.sh)
  DIRECTORY          Directory to search for tests (default: current directory)

Examples:
  shell-spec                      # Run all *_test.sh files in current directory
  shell-spec tests/               # Run tests in 'tests' directory
  shell-spec "*_spec.sh"          # Use custom file pattern
  shell-spec --html report.html   # Generate HTML report

Documentation: https://github.com/<user>/shell-spec
```

### 3.2 VERSION File Specification

#### 3.2.1 Format

```
0.6.0
```

**Rules:**
- Single line, no trailing newline preferred (but tolerate it)
- Semantic versioning format: MAJOR.MINOR.PATCH
- No "v" prefix
- No additional metadata (build numbers, etc.)
- Pre-release versions allowed: `0.7.0-beta.1`

#### 3.2.2 Location

- Source: `/VERSION` (repository root)
- Installed: `/usr/local/lib/shell-spec/VERSION`

### 3.3 Package Manager Specifications

#### 3.3.1 npm Package

**Package Name**: `shell-spec`

**Registry**: https://www.npmjs.com/package/shell-spec

**Install Command**:
```bash
npm install -g shell-spec
```

**Binary**: After installation, `shell-spec` command is available globally.

**Scope**: Unscoped (not @org/shell-spec)

#### 3.3.2 Homebrew Formula

**Tap Repository**: `<username>/homebrew-tap`

**Formula Name**: `shell-spec.rb`

**Install Commands**:
```bash
brew tap <username>/tap
brew install shell-spec
```

**Alternative (without tap)**:
```bash
brew install <username>/tap/shell-spec
```

#### 3.3.3 curl Installer

**URL**: `https://raw.githubusercontent.com/<user>/<repo>/main/install.sh`

**Install Command**:
```bash
curl -fsSL https://raw.githubusercontent.com/<user>/<repo>/main/install.sh | bash
```

**With version**:
```bash
curl -fsSL https://raw.githubusercontent.com/<user>/<repo>/main/install.sh | bash -s -- v0.6.0
```

### 3.4 Installation Paths

#### 3.4.1 Default Paths (Unix/macOS)

| Item | Path |
|------|------|
| Executable | `/usr/local/bin/shell-spec` |
| Library | `/usr/local/lib/shell-spec/` |
| Source files | `/usr/local/lib/shell-spec/*.sh` |
| VERSION | `/usr/local/lib/shell-spec/VERSION` |

#### 3.4.2 User-Local Paths (no sudo)

| Item | Path |
|------|------|
| Executable | `~/.local/bin/shell-spec` |
| Library | `~/.local/lib/shell-spec/` |

**Configuration**:
```bash
make install PREFIX=~/.local
```

#### 3.4.3 npm Global Paths

Managed by npm; typically:
- macOS/Linux: `~/.npm-global/bin/shell-spec` or `/usr/local/bin/shell-spec`
- Depends on npm prefix configuration

---

## 4. Technical Design

### 4.1 bin/shell-spec (CLI Wrapper)

```bash
#!/usr/bin/env bash
# =============================================================================
# shell-spec - CLI entry point
# =============================================================================
#
# This wrapper script locates and invokes the shell-spec test runner.
# It handles:
#   - Finding the library directory (installed or development)
#   - Processing --version and --help flags directly
#   - Passing all other arguments to test_runner.sh
#
# =============================================================================

set -euo pipefail

# Determine script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Find library directory
# Priority: 1) Relative to bin (installed), 2) Relative to bin/../src (development)
if [[ -d "${SCRIPT_DIR}/../lib/shell-spec" ]]; then
    # Installed location: /usr/local/bin/../lib/shell-spec
    LIB_DIR="${SCRIPT_DIR}/../lib/shell-spec"
elif [[ -d "${SCRIPT_DIR}/../src" ]]; then
    # Development location: ./bin/../src
    LIB_DIR="${SCRIPT_DIR}/../src"
else
    echo "Error: Cannot locate shell-spec library" >&2
    exit 1
fi

# Resolve to absolute path
LIB_DIR="$(cd "${LIB_DIR}" && pwd)"

# Handle --version / -v
if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
    VERSION_FILE="${LIB_DIR}/VERSION"
    if [[ -f "${VERSION_FILE}" ]]; then
        echo "shell-spec $(cat "${VERSION_FILE}")"
    elif [[ -f "${SCRIPT_DIR}/../VERSION" ]]; then
        echo "shell-spec $(cat "${SCRIPT_DIR}/../VERSION")"
    else
        echo "shell-spec (version unknown)"
    fi
    exit 0
fi

# Handle --help / -h
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
shell-spec - A lightweight shell script testing framework

Usage: shell-spec [OPTIONS] [PATTERN] [DIRECTORY]

Options:
  -h, --help         Show this help message and exit
  -v, --version      Show version number and exit
  --html <file>      Generate HTML report to specified file
  --verbose          Enable verbose output
  --watch            Enable watch mode for continuous testing
  --tap              Output in TAP format

Arguments:
  PATTERN            Test file pattern (default: *_test.sh)
  DIRECTORY          Directory to search for tests (default: current directory)

Examples:
  shell-spec                      # Run all *_test.sh files in current directory
  shell-spec tests/               # Run tests in 'tests' directory
  shell-spec "*_spec.sh"          # Use custom file pattern
  shell-spec --html report.html   # Generate HTML report

Documentation: https://github.com/<user>/shell-spec
EOF
    exit 0
fi

# Execute test runner with all arguments
exec bash "${LIB_DIR}/test_runner.sh" "$@"
```

### 4.2 package.json (npm Configuration)

```json
{
  "name": "shell-spec",
  "version": "0.6.0",
  "description": "A lightweight, zero-dependency shell script testing framework with TAP output, mocking, and code coverage",
  "keywords": [
    "shell",
    "bash",
    "testing",
    "test-framework",
    "unit-testing",
    "tap",
    "shell-script",
    "bats-alternative"
  ],
  "homepage": "https://github.com/<user>/shell-spec#readme",
  "bugs": {
    "url": "https://github.com/<user>/shell-spec/issues"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/<user>/shell-spec.git"
  },
  "license": "MIT",
  "author": "<Author Name> <email@example.com>",
  "bin": {
    "shell-spec": "./bin/shell-spec"
  },
  "files": [
    "bin/",
    "src/",
    "VERSION",
    "LICENSE",
    "README.md"
  ],
  "main": "",
  "scripts": {
    "test": "bash src/test_runner.sh",
    "version": "cat VERSION"
  },
  "engines": {
    "node": ">=14.0.0"
  },
  "os": [
    "darwin",
    "linux",
    "!win32"
  ],
  "preferGlobal": true
}
```

**Key Fields Explained:**

| Field | Purpose |
|-------|---------|
| `name` | Package name on npm registry |
| `version` | Must match VERSION file exactly |
| `bin` | Maps command name to executable script |
| `files` | Whitelist of files to include in package |
| `engines` | Minimum Node.js version (for npm install) |
| `os` | Supported platforms (excludes Windows) |
| `preferGlobal` | Warns if installed locally instead of globally |

### 4.3 VERSION File

```
0.6.0
```

**Validation Script** (to be used in CI):
```bash
#!/bin/bash
# Verify VERSION file format
VERSION=$(cat VERSION)
if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
    echo "Invalid VERSION format: ${VERSION}"
    exit 1
fi
echo "VERSION is valid: ${VERSION}"
```

### 4.4 CHANGELOG.md

```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

## [0.6.0] - YYYY-MM-DD

### Added
- npm package distribution (`npm install -g shell-spec`)
- Homebrew formula via tap (`brew install <user>/tap/shell-spec`)
- Universal curl installer script
- Makefile with install/uninstall targets
- `--version` / `-v` flag for version display
- `--help` / `-h` flag with usage information
- VERSION file for centralized version tracking
- This CHANGELOG.md file

### Changed
- CLI entry point moved from direct script invocation to `shell-spec` command
- README updated with comprehensive installation instructions

### Notes
- Backward compatible: direct `bash src/test_runner.sh` invocation still works

## [0.5.0] - YYYY-MM-DD

### Added
- GitHub Actions CI workflow (`.github/workflows/ci.yml`)
- GitHub Actions release workflow (`.github/workflows/release.yml`)
- ShellCheck configuration (`.shellcheckrc`)
- Multi-platform testing (Ubuntu, macOS)
- Multi-shell testing (bash, zsh, sh)
- Alpine Linux portability testing

## [0.4.0] - YYYY-MM-DD

### Added
- Code coverage analysis via `trap DEBUG`
- Line-by-line coverage reporting
- Coverage percentage calculation

## [0.3.0] - YYYY-MM-DD

### Added
- Function mocking with `mock_function`
- Command stubbing with `stub_command`
- Mock verification and call tracking

## [0.2.0] - YYYY-MM-DD

### Added
- TAP (Test Anything Protocol) output format
- `--tap` command line option
- TAP reporter module

## [0.1.0] - YYYY-MM-DD

### Added
- Initial release
- Core test runner functionality
- Assertion library (assert_equals, assert_success, etc.)
- HTML report generation
- Watch mode
- Progress bar display

[Unreleased]: https://github.com/<user>/shell-spec/compare/v0.6.0...HEAD
[0.6.0]: https://github.com/<user>/shell-spec/compare/v0.5.0...v0.6.0
[0.5.0]: https://github.com/<user>/shell-spec/compare/v0.4.0...v0.5.0
[0.4.0]: https://github.com/<user>/shell-spec/compare/v0.3.0...v0.4.0
[0.3.0]: https://github.com/<user>/shell-spec/compare/v0.2.0...v0.3.0
[0.2.0]: https://github.com/<user>/shell-spec/compare/v0.1.0...v0.2.0
[0.1.0]: https://github.com/<user>/shell-spec/releases/tag/v0.1.0
```

### 4.5 install.sh (Universal Installer)

```bash
#!/usr/bin/env bash
# =============================================================================
# install.sh - Universal shell-spec installer
# =============================================================================
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/<user>/shell-spec/main/install.sh | bash
#   curl -fsSL ... | bash -s -- v0.6.0           # Specific version
#   curl -fsSL ... | bash -s -- --prefix ~/.local # Custom prefix
#
# Options:
#   --prefix <path>   Installation prefix (default: /usr/local)
#   --version <ver>   Specific version to install (default: latest)
#   --uninstall       Remove shell-spec installation
#   --help            Show this help message
#
# =============================================================================

set -euo pipefail

# Defaults
PREFIX="/usr/local"
VERSION="latest"
UNINSTALL=false
REPO_URL="https://github.com/<user>/shell-spec"
REPO_RAW="https://raw.githubusercontent.com/<user>/shell-spec"

# Colors (if terminal supports them)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

info() { echo -e "${BLUE}[INFO]${NC} $*"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

usage() {
    cat << 'EOF'
shell-spec installer

Usage:
  install.sh [OPTIONS]

Options:
  --prefix <path>   Installation prefix (default: /usr/local)
  --version <ver>   Specific version to install (default: latest)
  --uninstall       Remove shell-spec installation
  --help            Show this help message

Examples:
  # Install latest version
  curl -fsSL https://raw.githubusercontent.com/<user>/shell-spec/main/install.sh | bash

  # Install specific version
  curl -fsSL ... | bash -s -- --version v0.6.0

  # Install to user directory (no sudo)
  curl -fsSL ... | bash -s -- --prefix ~/.local

  # Uninstall
  curl -fsSL ... | bash -s -- --uninstall
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --prefix)
            PREFIX="$2"
            shift 2
            ;;
        --version)
            VERSION="$2"
            shift 2
            ;;
        --uninstall)
            UNINSTALL=true
            shift
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        v*)
            # Allow version as positional argument
            VERSION="$1"
            shift
            ;;
        *)
            error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

BIN_DIR="${PREFIX}/bin"
LIB_DIR="${PREFIX}/lib/shell-spec"

# Uninstall mode
if [[ "${UNINSTALL}" == "true" ]]; then
    info "Uninstalling shell-spec..."

    if [[ -L "${BIN_DIR}/shell-spec" ]] || [[ -f "${BIN_DIR}/shell-spec" ]]; then
        rm -f "${BIN_DIR}/shell-spec"
        info "Removed ${BIN_DIR}/shell-spec"
    fi

    if [[ -d "${LIB_DIR}" ]]; then
        rm -rf "${LIB_DIR}"
        info "Removed ${LIB_DIR}"
    fi

    success "shell-spec uninstalled successfully"
    exit 0
fi

# Check dependencies
command -v curl >/dev/null 2>&1 || { error "curl is required but not installed"; exit 1; }
command -v tar >/dev/null 2>&1 || { error "tar is required but not installed"; exit 1; }

# Determine version to install
if [[ "${VERSION}" == "latest" ]]; then
    info "Fetching latest version..."
    VERSION=$(curl -fsSL "${REPO_URL}/releases/latest" -o /dev/null -w '%{url_effective}' | grep -o 'v[0-9.]*$' || echo "main")
    if [[ "${VERSION}" == "main" ]]; then
        warn "Could not determine latest release, using main branch"
    else
        info "Latest version: ${VERSION}"
    fi
fi

# Ensure version has 'v' prefix for GitHub URLs
[[ "${VERSION}" != v* ]] && VERSION="v${VERSION}"

info "Installing shell-spec ${VERSION} to ${PREFIX}..."

# Create directories
mkdir -p "${BIN_DIR}"
mkdir -p "${LIB_DIR}"

# Download and extract
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "${TEMP_DIR}"' EXIT

info "Downloading from ${REPO_URL}..."

if [[ "${VERSION}" == "vmain" ]]; then
    ARCHIVE_URL="${REPO_URL}/archive/refs/heads/main.tar.gz"
    EXTRACT_DIR="shell-spec-main"
else
    ARCHIVE_URL="${REPO_URL}/archive/refs/tags/${VERSION}.tar.gz"
    EXTRACT_DIR="shell-spec-${VERSION#v}"
fi

curl -fsSL "${ARCHIVE_URL}" | tar -xz -C "${TEMP_DIR}"

# Install files
info "Installing files..."

# Copy source files
cp -r "${TEMP_DIR}/${EXTRACT_DIR}/src/"* "${LIB_DIR}/"

# Copy VERSION file
if [[ -f "${TEMP_DIR}/${EXTRACT_DIR}/VERSION" ]]; then
    cp "${TEMP_DIR}/${EXTRACT_DIR}/VERSION" "${LIB_DIR}/"
else
    echo "${VERSION#v}" > "${LIB_DIR}/VERSION"
fi

# Install CLI wrapper
cp "${TEMP_DIR}/${EXTRACT_DIR}/bin/shell-spec" "${BIN_DIR}/shell-spec"
chmod +x "${BIN_DIR}/shell-spec"

# Verify installation
if command -v shell-spec >/dev/null 2>&1 || [[ -x "${BIN_DIR}/shell-spec" ]]; then
    success "shell-spec ${VERSION} installed successfully!"
    info ""
    info "Usage:"
    info "  shell-spec              # Run tests in current directory"
    info "  shell-spec --version    # Show version"
    info "  shell-spec --help       # Show help"
    info ""

    # Check if bin directory is in PATH
    if [[ ":${PATH}:" != *":${BIN_DIR}:"* ]]; then
        warn "${BIN_DIR} is not in your PATH"
        info "Add this to your shell profile:"
        info "  export PATH=\"${BIN_DIR}:\$PATH\""
    fi
else
    error "Installation verification failed"
    exit 1
fi
```

### 4.6 Makefile

```makefile
# =============================================================================
# Makefile - shell-spec build and installation
# =============================================================================
#
# Usage:
#   make install          # Install to /usr/local (may require sudo)
#   make install PREFIX=~/.local  # Install to user directory
#   make uninstall        # Remove installation
#   make test             # Run tests
#   make lint             # Run ShellCheck
#   make clean            # Clean build artifacts
#
# =============================================================================

# Configuration
PREFIX ?= /usr/local
BIN_DIR = $(PREFIX)/bin
LIB_DIR = $(PREFIX)/lib/shell-spec

# Files to install
SRC_FILES = src/test_runner.sh \
            src/assertions.sh \
            src/report_template.html

# Version
VERSION := $(shell cat VERSION 2>/dev/null || echo "dev")

.PHONY: all install uninstall test lint clean help version

# Default target
all: help

# Help
help:
    @echo "shell-spec Makefile"
    @echo ""
    @echo "Usage:"
    @echo "  make install          Install to $(PREFIX)"
    @echo "  make install PREFIX=~/.local"
    @echo "                        Install to user directory"
    @echo "  make uninstall        Remove installation"
    @echo "  make test             Run tests"
    @echo "  make lint             Run ShellCheck"
    @echo "  make clean            Clean build artifacts"
    @echo "  make version          Show version"
    @echo ""
    @echo "Current version: $(VERSION)"

# Version
version:
    @echo "$(VERSION)"

# Install
install: $(SRC_FILES) VERSION bin/shell-spec
    @echo "Installing shell-spec $(VERSION) to $(PREFIX)..."
    @mkdir -p $(BIN_DIR)
    @mkdir -p $(LIB_DIR)
    @cp $(SRC_FILES) $(LIB_DIR)/
    @cp VERSION $(LIB_DIR)/
    @cp bin/shell-spec $(BIN_DIR)/shell-spec
    @chmod +x $(BIN_DIR)/shell-spec
    @echo ""
    @echo "Installation complete!"
    @echo "  Executable: $(BIN_DIR)/shell-spec"
    @echo "  Library:    $(LIB_DIR)/"
    @echo ""
    @echo "Run 'shell-spec --version' to verify installation"

# Uninstall
uninstall:
    @echo "Uninstalling shell-spec from $(PREFIX)..."
    @rm -f $(BIN_DIR)/shell-spec
    @rm -rf $(LIB_DIR)
    @echo "Uninstallation complete!"

# Test
test:
    @echo "Running shell-spec tests..."
    @bash src/test_runner.sh

# Lint (requires shellcheck)
lint:
    @echo "Running ShellCheck..."
    @shellcheck src/*.sh bin/shell-spec install.sh || true

# Clean
clean:
    @echo "Cleaning build artifacts..."
    @rm -rf dist/
    @rm -f *.tar.gz *.zip

# Package for distribution (creates tarball)
dist: clean
    @echo "Creating distribution package..."
    @mkdir -p dist
    @tar -czvf dist/shell-spec-$(VERSION).tar.gz \
        --transform 's,^,shell-spec-$(VERSION)/,' \
        bin/ src/ VERSION LICENSE README.md CHANGELOG.md Makefile install.sh
    @echo "Created dist/shell-spec-$(VERSION).tar.gz"
```

### 4.7 Homebrew Formula (Reference)

This file would live in a separate tap repository: `<username>/homebrew-tap/Formula/shell-spec.rb`

```ruby
# =============================================================================
# shell-spec.rb - Homebrew formula for shell-spec
# =============================================================================
#
# Installation:
#   brew tap <username>/tap
#   brew install shell-spec
#
# =============================================================================

class ShellSpec < Formula
  desc "Lightweight, zero-dependency shell script testing framework"
  homepage "https://github.com/<user>/shell-spec"
  url "https://github.com/<user>/shell-spec/archive/refs/tags/v0.6.0.tar.gz"
  sha256 "PLACEHOLDER_SHA256_HASH"
  license "MIT"
  head "https://github.com/<user>/shell-spec.git", branch: "main"

  # No dependencies - pure bash
  # depends_on "bash" # Optional: uncomment if bash 4+ required

  def install
    # Install library files
    libexec.install Dir["src/*"]
    libexec.install "VERSION"

    # Install CLI wrapper
    bin.install "bin/shell-spec"

    # Update wrapper to point to libexec
    inreplace bin/"shell-spec",
      '${SCRIPT_DIR}/../lib/shell-spec',
      libexec.to_s
  end

  test do
    # Create a simple test file
    (testpath/"test_example.sh").write <<~EOS
      #!/bin/bash
      source "#{libexec}/assertions.sh"

      test_simple_pass() {
        assert_equals "hello" "hello"
      }
    EOS

    # Run the test
    output = shell_output("#{bin}/shell-spec #{testpath}")
    assert_match "PASS", output
  end
end
```

### 4.8 src/test_runner.sh Modifications

Add version/help handling to the existing argument parsing section:

```bash
# Add to the argument parsing section (around line 33-53)

# Handle --version / -v first (exit immediately)
if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
    VERSION_FILE="${SCRIPT_DIR}/VERSION"
    if [[ -f "${VERSION_FILE}" ]]; then
        echo "shell-spec $(cat "${VERSION_FILE}")"
    else
        echo "shell-spec (version unknown)"
    fi
    exit 0
fi

# Handle --help / -h (exit immediately)
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
shell-spec - A lightweight shell script testing framework

Usage: shell-spec [OPTIONS] [PATTERN] [DIRECTORY]

Options:
  -h, --help         Show this help message and exit
  -v, --version      Show version number and exit
  --html <file>      Generate HTML report to specified file
  --verbose          Enable verbose output
  --watch            Enable watch mode for continuous testing
  --tap              Output in TAP format

Arguments:
  PATTERN            Test file pattern (default: *_test.sh)
  DIRECTORY          Directory to search for tests (default: current directory)

Examples:
  shell-spec                      # Run all *_test.sh files
  shell-spec tests/               # Run tests in 'tests' directory
  shell-spec "*_spec.sh"          # Use custom file pattern
  shell-spec --html report.html   # Generate HTML report
EOF
    exit 0
fi
```

---

## 5. Workflows

### 5.1 npm Installation Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         npm Installation Workflow                            │
└─────────────────────────────────────────────────────────────────────────────┘

  User
    │
    │  npm install -g shell-spec
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. npm resolves package                                                      │
│    • Queries registry.npmjs.org                                             │
│    • Downloads shell-spec@0.6.0                                             │
│    • Verifies integrity                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. npm extracts package                                                      │
│    • Creates node_modules/shell-spec/                                       │
│    • Copies files from "files" array in package.json                        │
│    • Sets up bin links                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. npm creates symlinks                                                      │
│    • Links bin/shell-spec to global bin directory                          │
│    • Location varies by npm config (typically ~/.npm-global/bin/)          │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Verification                                                              │
│    $ shell-spec --version                                                   │
│    shell-spec 0.6.0                                                         │
│                                                                             │
│    $ which shell-spec                                                       │
│    /Users/<user>/.npm-global/bin/shell-spec                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 curl Installer Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       curl Installer Workflow                                │
└─────────────────────────────────────────────────────────────────────────────┘

  User
    │
    │  curl -fsSL https://.../install.sh | bash
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. Download installer script                                                 │
│    • curl fetches install.sh from GitHub                                    │
│    • Script is piped directly to bash                                       │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Parse arguments and detect latest version                                 │
│    • Default: fetch latest release tag from GitHub API                      │
│    • Or use specified version: --version v0.6.0                            │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Download and extract release archive                                      │
│    • curl -fsSL $REPO/archive/refs/tags/v0.6.0.tar.gz                       │
│    • tar -xz to temporary directory                                         │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Install files to system directories                                       │
│    • Create /usr/local/lib/shell-spec/                                      │
│    • Copy src/*.sh, VERSION                                                 │
│    • Copy bin/shell-spec to /usr/local/bin/                                 │
│    • chmod +x /usr/local/bin/shell-spec                                     │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. Cleanup and verify                                                        │
│    • Remove temporary directory                                             │
│    • Print success message                                                  │
│    • Warn if /usr/local/bin not in PATH                                     │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. Ready to use                                                              │
│    $ shell-spec --version                                                   │
│    shell-spec 0.6.0                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 npm Publish Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        npm Publish Workflow                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  Maintainer
    │
    │  Trigger: Push tag v0.6.0
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. GitHub Actions Release Workflow (from v0.5.0)                             │
│    • Triggered by: push tags v*.*.*                                         │
│    • Validates: ShellCheck, tests, portability                              │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    │ on success
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. NEW: npm Publish Job                                                      │
│    • Requires: NPM_TOKEN secret configured                                  │
│    • Runs: npm publish                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. npm Registry receives package                                             │
│    • Package available at npmjs.com/package/shell-spec                      │
│    • Version 0.6.0 is now installable                                       │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Users can install                                                         │
│    $ npm install -g shell-spec                                              │
│    + shell-spec@0.6.0                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 Version Bump Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Version Bump Workflow                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Maintainer prepares new release
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. Update VERSION file                                                       │
│    $ echo "0.7.0" > VERSION                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Update package.json                                                       │
│    • Change "version": "0.6.0" to "version": "0.7.0"                        │
│    • Or use: npm version 0.7.0 --no-git-tag-version                         │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. Update CHANGELOG.md                                                       │
│    • Move [Unreleased] items to [0.7.0] section                             │
│    • Add release date                                                       │
│    • Update comparison links at bottom                                      │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. Verify versions match                                                     │
│    $ cat VERSION                                                            │
│    0.7.0                                                                    │
│    $ grep '"version"' package.json                                          │
│    "version": "0.7.0",                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. Commit and tag                                                            │
│    $ git add VERSION package.json CHANGELOG.md                              │
│    $ git commit -m "Release v0.7.0"                                         │
│    $ git tag v0.7.0                                                         │
│    $ git push origin main --tags                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Use Cases

### 6.1 UC-01: New User Quick Install via npm

**Actor**: Developer new to shell-spec
**Goal**: Install and run first test in under 2 minutes

**Scenario**:
```bash
# 1. Install globally
$ npm install -g shell-spec
added 1 package in 2s

# 2. Verify installation
$ shell-spec --version
shell-spec 0.6.0

# 3. Create first test
$ cat > my_test.sh << 'EOF'
#!/bin/bash
source "$(shell-spec --lib)/assertions.sh"

test_hello_world() {
    assert_equals "hello" "hello"
}
EOF

# 4. Run test
$ shell-spec
Found 1 test.
Running tests: [====================] 1/1 (100%)

| File         | Test Function    | Status |
|--------------|------------------|--------|
| my_test.sh   | test_hello_world | PASS   |

--------------------
Test Summary
--------------------
Total tests: 1
Passed: 1
Failed: 0
--------------------
```

### 6.2 UC-02: CI Environment Installation

**Actor**: CI pipeline (GitHub Actions, Jenkins, etc.)
**Goal**: Install shell-spec in ephemeral environment

**Scenario (GitHub Actions)**:
```yaml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shell-spec
        run: npm install -g shell-spec

      - name: Run tests
        run: shell-spec tests/
```

**Alternative (curl installer)**:
```yaml
      - name: Install shell-spec
        run: curl -fsSL https://raw.githubusercontent.com/<user>/shell-spec/main/install.sh | bash
```

### 6.3 UC-03: macOS User via Homebrew

**Actor**: macOS developer preferring Homebrew
**Goal**: Install via familiar package manager

**Scenario**:
```bash
# 1. Add tap (one-time)
$ brew tap <username>/tap
==> Tapping <username>/tap
Cloned into /opt/homebrew/Library/Taps/<username>/homebrew-tap

# 2. Install
$ brew install shell-spec
==> Installing shell-spec from <username>/tap
==> Downloading https://github.com/<user>/shell-spec/archive/v0.6.0.tar.gz
==> Installing...
🍺  /opt/homebrew/Cellar/shell-spec/0.6.0

# 3. Verify
$ shell-spec --version
shell-spec 0.6.0
```

### 6.4 UC-04: System Administrator Manual Install

**Actor**: Sysadmin managing multiple servers
**Goal**: Install to custom location without external package managers

**Scenario**:
```bash
# 1. Clone repository
$ git clone https://github.com/<user>/shell-spec.git
$ cd shell-spec

# 2. Install to /opt for system-wide access
$ sudo make install PREFIX=/opt/shell-spec

# 3. Add to system PATH
$ echo 'export PATH="/opt/shell-spec/bin:$PATH"' | sudo tee /etc/profile.d/shell-spec.sh

# 4. Verify
$ source /etc/profile.d/shell-spec.sh
$ shell-spec --version
shell-spec 0.6.0
```

### 6.5 UC-05: User Without sudo Access

**Actor**: Developer on shared workstation
**Goal**: Install without root privileges

**Scenario**:
```bash
# 1. Install to user directory
$ curl -fsSL https://.../install.sh | bash -s -- --prefix ~/.local

# 2. Ensure ~/.local/bin is in PATH
$ echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
$ source ~/.bashrc

# 3. Verify
$ shell-spec --version
shell-spec 0.6.0

$ which shell-spec
/home/user/.local/bin/shell-spec
```

### 6.6 UC-06: Upgrading to New Version

**Actor**: Existing user with v0.5.0 installed
**Goal**: Upgrade to v0.6.0

**Scenario (npm)**:
```bash
$ npm update -g shell-spec
+ shell-spec@0.6.0
updated 1 package in 1s

$ shell-spec --version
shell-spec 0.6.0
```

**Scenario (Homebrew)**:
```bash
$ brew upgrade shell-spec
==> Upgrading shell-spec 0.5.0 -> 0.6.0

$ shell-spec --version
shell-spec 0.6.0
```

**Scenario (curl/make)**:
```bash
# Re-run installer
$ curl -fsSL https://.../install.sh | bash
Installing shell-spec v0.6.0...
Installation complete!
```

---

## 7. Decision Trees

### 7.1 Installation Method Selection

```
                    ┌─────────────────────────────┐
                    │  How to install shell-spec? │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Do you have Node.js/npm?  │
                    └─────────────┬─────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │ Yes                 │ No                  │
            ▼                     ▼                     │
    ┌───────────────┐     ┌───────────────────┐        │
    │ npm install   │     │ macOS user?       │        │
    │ -g shell-spec │     └─────────┬─────────┘        │
    │               │               │                   │
    │ (Recommended) │         ┌─────┴─────┐            │
    └───────────────┘         │ Yes       │ No         │
                              ▼           ▼            │
                    ┌─────────────┐ ┌─────────────────┐│
                    │ brew install│ │ sudo available? ││
                    │ <tap>/      │ └────────┬────────┘│
                    │ shell-spec  │          │         │
                    └─────────────┘    ┌─────┴─────┐   │
                                       │ Yes       │ No│
                                       ▼           ▼   │
                             ┌─────────────┐ ┌────────────────┐
                             │ curl ...    │ │ curl ... |     │
                             │ | bash      │ │ bash -s --     │
                             │             │ │ --prefix       │
                             │ (installs   │ │ ~/.local       │
                             │ to /usr/    │ │                │
                             │ local)      │ │ (no sudo)      │
                             └─────────────┘ └────────────────┘
```

### 7.2 Library Location Resolution

```
                    ┌─────────────────────────────┐
                    │  bin/shell-spec executes    │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Where is SCRIPT_DIR?      │
                    │ (dirname of shell-spec)   │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Does ../lib/shell-spec/   │
                    │ exist?                    │
                    └─────────────┬─────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │ Yes                                       │ No
            ▼                                           ▼
    ┌───────────────────────┐               ┌───────────────────────┐
    │ INSTALLED MODE        │               │ Does ../src/ exist?   │
    │                       │               └───────────┬───────────┘
    │ LIB_DIR =             │                           │
    │ ../lib/shell-spec     │               ┌───────────┴───────────┐
    │                       │               │ Yes                   │ No
    │ Typical:              │               ▼                       ▼
    │ /usr/local/lib/       │       ┌───────────────┐       ┌───────────────┐
    │ shell-spec/           │       │ DEVELOPMENT   │       │ ERROR         │
    └───────────────────────┘       │ MODE          │       │               │
                                    │               │       │ Cannot locate │
                                    │ LIB_DIR =     │       │ shell-spec    │
                                    │ ../src        │       │ library       │
                                    │               │       │               │
                                    │ (running from │       │ Exit 1        │
                                    │ git clone)    │       │               │
                                    └───────────────┘       └───────────────┘
```

### 7.3 Version Consistency Check

```
                    ┌─────────────────────────────┐
                    │  CI Release Build           │
                    └─────────────┬───────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ Read version sources:     │
                    │ 1. VERSION file           │
                    │ 2. package.json "version" │
                    │ 3. Git tag                │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │ All three match?          │
                    └─────────────┬─────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │ Yes                                       │ No
            ▼                                           ▼
    ┌───────────────────────┐               ┌───────────────────────┐
    │ PROCEED               │               │ FAIL BUILD            │
    │                       │               │                       │
    │ Continue to npm       │               │ "Version mismatch     │
    │ publish and           │               │ detected:             │
    │ release creation      │               │ VERSION: 0.6.0        │
    │                       │               │ package.json: 0.5.0   │
    │                       │               │ git tag: v0.6.1"      │
    │                       │               │                       │
    │                       │               │ Exit 1                │
    └───────────────────────┘               └───────────────────────┘
```

---

## 8. Logging & Diagnostics

### 8.1 Installer Output Messages

| Event | Message | Level |
|-------|---------|-------|
| Start | `Installing shell-spec v0.6.0 to /usr/local...` | INFO |
| Download | `Downloading from https://github.com/...` | INFO |
| Extract | `Extracting archive...` | INFO (verbose) |
| Install | `Installing files...` | INFO |
| Success | `shell-spec v0.6.0 installed successfully!` | SUCCESS |
| Path Warning | `/usr/local/bin is not in your PATH` | WARN |
| Error | `Error: Cannot locate shell-spec library` | ERROR |

### 8.2 Installer Debug Mode

```bash
# Enable verbose output
$ SHELL_SPEC_DEBUG=1 curl -fsSL .../install.sh | bash

[DEBUG] Script started
[DEBUG] PREFIX=/usr/local
[DEBUG] VERSION=latest
[DEBUG] Fetching latest version...
[DEBUG] Resolved version: v0.6.0
[DEBUG] ARCHIVE_URL=https://github.com/.../v0.6.0.tar.gz
[DEBUG] TEMP_DIR=/tmp/tmp.xyz123
[DEBUG] Downloading...
[DEBUG] Downloaded 45KB
[DEBUG] Extracting to /tmp/tmp.xyz123
[DEBUG] Found files: test_runner.sh, assertions.sh, ...
[DEBUG] Creating /usr/local/lib/shell-spec
[DEBUG] Copying src/*.sh
[DEBUG] Copying VERSION
[DEBUG] Installing bin/shell-spec to /usr/local/bin
[DEBUG] Setting executable permission
[DEBUG] Cleanup: removing /tmp/tmp.xyz123
[SUCCESS] shell-spec v0.6.0 installed successfully!
```

### 8.3 npm Install Diagnostics

```bash
# Verbose npm install
$ npm install -g shell-spec --loglevel verbose

npm verb cli node v20.0.0
npm verb cli npm v10.0.0
npm verb cli command install
npm verb config using "/Users/user/.npmrc"
npm verb npm-session abc123
npm verb lock using /Users/user/.npm/_locks/staging-xyz.lock
npm verb reify retrieving registry.npmjs.org for shell-spec
npm verb fetch GET 200 https://registry.npmjs.org/shell-spec 150ms
npm verb reify Finished in 300ms
npm verb save writing to package.json
+ shell-spec@0.6.0
```

### 8.4 Error Diagnostics

**Library Not Found**:
```bash
$ shell-spec
Error: Cannot locate shell-spec library
  Searched:
    /usr/local/lib/shell-spec (not found)
    /usr/local/bin/../src (not found)

Please reinstall shell-spec or set SHELL_SPEC_LIB environment variable.
```

**Permission Denied**:
```bash
$ ./install.sh
[ERROR] Cannot write to /usr/local/lib
  You may need to run with sudo:
    sudo bash install.sh

  Or install to user directory:
    bash install.sh --prefix ~/.local
```

**Version Mismatch Warning**:
```bash
$ shell-spec --version
shell-spec 0.6.0

# If VERSION file is missing:
$ shell-spec --version
shell-spec (version unknown)
```

---

## 9. Documentation Requirements

### 9.1 README.md Updates

```markdown
## Installation

### Quick Install (npm)

```bash
npm install -g shell-spec
```

### Homebrew (macOS)

```bash
brew tap <username>/tap
brew install shell-spec
```

### curl Installer

```bash
curl -fsSL https://raw.githubusercontent.com/<user>/shell-spec/main/install.sh | bash
```

To install without sudo:
```bash
curl -fsSL https://.../install.sh | bash -s -- --prefix ~/.local
```

### Manual Installation

```bash
git clone https://github.com/<user>/shell-spec.git
cd shell-spec
make install           # Installs to /usr/local
# or
make install PREFIX=~/.local  # Installs to user directory
```

### Verify Installation

```bash
shell-spec --version
# shell-spec 0.6.0
```

## Uninstallation

### npm
```bash
npm uninstall -g shell-spec
```

### Homebrew
```bash
brew uninstall shell-spec
```

### curl/make
```bash
curl -fsSL https://.../install.sh | bash -s -- --uninstall
# or
make uninstall
```
```

### 9.2 npm Package README

The npm package should include a condensed README focused on:
- Quick start example
- Link to full documentation on GitHub
- Badge for npm version

### 9.3 Homebrew Tap README

The tap repository needs:
- Installation instructions
- List of available formulas
- Contribution guidelines

---

## 10. Deliverables Checklist

### 10.1 New Files

- [ ] **`bin/shell-spec`** (~55 lines)
  - [ ] Library location resolution
  - [ ] --version handling
  - [ ] --help handling
  - [ ] Argument pass-through to test_runner.sh

- [ ] **`package.json`** (~40 lines)
  - [ ] Package metadata (name, version, description)
  - [ ] bin configuration
  - [ ] files whitelist
  - [ ] engines and os restrictions
  - [ ] repository and bugs URLs

- [ ] **`VERSION`** (1 line)
  - [ ] Initial version: 0.6.0

- [ ] **`CHANGELOG.md`** (~100 lines)
  - [ ] All versions from 0.1.0 to 0.6.0
  - [ ] Keep a Changelog format
  - [ ] Comparison links

- [ ] **`install.sh`** (~80 lines)
  - [ ] Argument parsing (--prefix, --version, --uninstall)
  - [ ] Latest version detection
  - [ ] Download and extract
  - [ ] File installation
  - [ ] PATH warning
  - [ ] Uninstall mode

- [ ] **`Makefile`** (~50 lines)
  - [ ] install target
  - [ ] uninstall target
  - [ ] test target
  - [ ] lint target
  - [ ] dist target
  - [ ] PREFIX variable support

### 10.2 Modified Files

- [ ] **`src/test_runner.sh`** (~20 lines added)
  - [ ] --version / -v flag
  - [ ] --help / -h flag
  - [ ] VERSION file reading

- [ ] **`README.md`** (~50 lines added)
  - [ ] Installation section with all methods
  - [ ] Uninstallation section
  - [ ] --version usage example

### 10.3 External Deliverables

- [ ] **npm Registry**
  - [ ] Package published to npmjs.com
  - [ ] NPM_TOKEN configured in GitHub secrets

- [ ] **Homebrew Tap Repository** (optional, can be deferred)
  - [ ] Repository: `<username>/homebrew-tap`
  - [ ] Formula: `Formula/shell-spec.rb`
  - [ ] README with installation instructions

### 10.4 CI/CD Updates

- [ ] **`.github/workflows/release.yml`** (from v0.5.0)
  - [ ] Add npm publish job
  - [ ] Add version consistency check

---

## 11. Testing Strategy

### 11.1 Installation Tests

**Test: npm global install**
```bash
# Install
npm install -g shell-spec

# Verify command exists
which shell-spec
# Expected: path to shell-spec

# Verify version
shell-spec --version
# Expected: shell-spec 0.6.0

# Verify functionality
echo 'test_pass() { :; }' > /tmp/test_pass.sh
shell-spec /tmp
# Expected: PASS output

# Cleanup
npm uninstall -g shell-spec
```

**Test: curl installer**
```bash
# Install
curl -fsSL https://.../install.sh | bash

# Verify
/usr/local/bin/shell-spec --version
# Expected: shell-spec 0.6.0

# Uninstall
curl -fsSL https://.../install.sh | bash -s -- --uninstall

# Verify removal
test -f /usr/local/bin/shell-spec && echo "FAIL" || echo "PASS"
# Expected: PASS
```

**Test: make install with custom prefix**
```bash
# Install
make install PREFIX=/tmp/shell-spec-test

# Verify structure
ls /tmp/shell-spec-test/bin/shell-spec
ls /tmp/shell-spec-test/lib/shell-spec/test_runner.sh
ls /tmp/shell-spec-test/lib/shell-spec/VERSION

# Verify execution
/tmp/shell-spec-test/bin/shell-spec --version
# Expected: shell-spec 0.6.0

# Cleanup
make uninstall PREFIX=/tmp/shell-spec-test
```

### 11.2 Version Consistency Tests

**Test: All version sources match**
```bash
#!/bin/bash
VERSION_FILE=$(cat VERSION)
PACKAGE_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "no-tag")
GIT_TAG=${GIT_TAG#v}  # Remove 'v' prefix

if [[ "${VERSION_FILE}" != "${PACKAGE_VERSION}" ]]; then
    echo "FAIL: VERSION (${VERSION_FILE}) != package.json (${PACKAGE_VERSION})"
    exit 1
fi

if [[ "${GIT_TAG}" != "no-tag" ]] && [[ "${VERSION_FILE}" != "${GIT_TAG}" ]]; then
    echo "FAIL: VERSION (${VERSION_FILE}) != git tag (${GIT_TAG})"
    exit 1
fi

echo "PASS: All versions match: ${VERSION_FILE}"
```

### 11.3 CLI Flag Tests

**Test: --version output format**
```bash
OUTPUT=$(shell-spec --version)
if [[ "${OUTPUT}" =~ ^shell-spec\ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
    echo "PASS"
else
    echo "FAIL: Unexpected format: ${OUTPUT}"
fi
```

**Test: --help output**
```bash
OUTPUT=$(shell-spec --help)
if [[ "${OUTPUT}" == *"Usage:"* ]] && [[ "${OUTPUT}" == *"--version"* ]]; then
    echo "PASS"
else
    echo "FAIL: Help output incomplete"
fi
```

**Test: -v and -h short forms**
```bash
# Short version
V_OUTPUT=$(shell-spec -v)
VERSION_OUTPUT=$(shell-spec --version)
[[ "${V_OUTPUT}" == "${VERSION_OUTPUT}" ]] && echo "PASS -v" || echo "FAIL -v"

# Short help
H_OUTPUT=$(shell-spec -h)
HELP_OUTPUT=$(shell-spec --help)
[[ "${H_OUTPUT}" == "${HELP_OUTPUT}" ]] && echo "PASS -h" || echo "FAIL -h"
```

### 11.4 Backward Compatibility Tests

**Test: Direct invocation still works**
```bash
# Old way still works
bash src/test_runner.sh --version
# Should work without errors (even if version output differs)

# Tests still run
bash src/test_runner.sh examples/
# Expected: Normal test output
```

### 11.5 Cross-Platform Tests

**Test matrix:**
| Platform | npm | curl | make | Homebrew |
|----------|-----|------|------|----------|
| Ubuntu 22.04 | ✓ | ✓ | ✓ | - |
| macOS 13 | ✓ | ✓ | ✓ | ✓ |
| Alpine | - | ✓ | ✓ | - |

---

## 12. Acceptance Criteria

### 12.1 Installation Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| IC-01 | `npm install -g shell-spec` succeeds | Run command, verify exit 0 |
| IC-02 | `shell-spec` command available after npm install | `which shell-spec` returns path |
| IC-03 | curl installer works | Full install/verify/uninstall cycle |
| IC-04 | `make install` works | Full install/verify/uninstall cycle |
| IC-05 | `--prefix` option works | Install to custom path, verify |
| IC-06 | Uninstall is clean | No orphaned files after uninstall |

### 12.2 CLI Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| CC-01 | `--version` shows version | Output matches `shell-spec X.Y.Z` format |
| CC-02 | `-v` is alias for `--version` | Same output as `--version` |
| CC-03 | `--help` shows usage | Contains "Usage:" and all options |
| CC-04 | `-h` is alias for `--help` | Same output as `--help` |
| CC-05 | Exit code 0 for --version | `echo $?` returns 0 |
| CC-06 | Exit code 0 for --help | `echo $?` returns 0 |

### 12.3 Version Management Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| VC-01 | VERSION file exists | `cat VERSION` succeeds |
| VC-02 | VERSION matches package.json | Compare both values |
| VC-03 | VERSION matches git tag | Compare on tagged commits |
| VC-04 | CHANGELOG.md exists | File present with entries |
| VC-05 | CHANGELOG format valid | Follows Keep a Changelog |

### 12.4 Package Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| PC-01 | npm package published | `npm view shell-spec` succeeds |
| PC-02 | Package contains required files | Check with `npm pack --dry-run` |
| PC-03 | No dev files in package | No tests, specs, or CI files |
| PC-04 | Package size reasonable | Less than 100KB |

### 12.5 Backward Compatibility Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| BC-01 | Direct script invocation works | `bash src/test_runner.sh` runs |
| BC-02 | Existing tests pass | All tests from previous versions |
| BC-03 | Sourcing assertions.sh works | Manual source in test file |

---

## Appendix A: npm Publishing Guide

### A.1 Initial Setup

```bash
# Create npm account at npmjs.com if needed

# Login locally
npm login

# Verify login
npm whoami
```

### A.2 First Publish

```bash
# From repository root
npm publish

# If package name is taken, consider scoped:
# Change name in package.json to "@username/shell-spec"
# npm publish --access public
```

### A.3 Automated Publishing (GitHub Actions)

Add to `.github/workflows/release.yml`:

```yaml
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify version consistency
        run: |
          VERSION=$(cat VERSION)
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          if [[ "$VERSION" != "$PKG_VERSION" ]] || [[ "$VERSION" != "$TAG_VERSION" ]]; then
            echo "Version mismatch!"
            exit 1
          fi

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### A.4 NPM_TOKEN Secret

1. Generate token at npmjs.com → Access Tokens → Generate New Token (Automation)
2. Add to GitHub repository: Settings → Secrets → Actions → New repository secret
3. Name: `NPM_TOKEN`, Value: (paste token)

---

## Appendix B: Homebrew Formula Guide

### B.1 Tap Repository Setup

```bash
# Create tap repository
# Name must be: homebrew-tap (the "homebrew-" prefix is required)

gh repo create homebrew-tap --public

# Clone and setup
git clone https://github.com/<username>/homebrew-tap
cd homebrew-tap
mkdir Formula
```

### B.2 Formula Creation

```bash
# Generate formula skeleton
brew create https://github.com/<user>/shell-spec/archive/v0.6.0.tar.gz

# Move to tap
mv /opt/homebrew/Library/Taps/homebrew/homebrew-core/Formula/shell-spec.rb \
   Formula/shell-spec.rb

# Edit formula (see section 4.7 for content)
```

### B.3 Testing Formula

```bash
# Install from local tap
brew install --build-from-source ./Formula/shell-spec.rb

# Run formula tests
brew test shell-spec

# Audit formula
brew audit --strict shell-spec
```

### B.4 Publishing

```bash
# Commit and push formula
git add Formula/shell-spec.rb
git commit -m "Add shell-spec 0.6.0"
git push

# Users can now install
brew tap <username>/tap
brew install shell-spec
```

---

## Appendix C: Troubleshooting

### C.1 npm Install Fails

**Symptom**: `npm install -g shell-spec` fails with permission error

**Solution**:
```bash
# Option 1: Fix npm permissions
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# Option 2: Use npx (no global install)
npx shell-spec --version
```

### C.2 Command Not Found After Install

**Symptom**: `shell-spec: command not found`

**Diagnosis**:
```bash
# Check where it was installed
npm list -g --depth=0 | grep shell-spec
npm bin -g

# Verify PATH
echo $PATH | tr ':' '\n' | grep npm
```

**Solution**:
```bash
# Add npm bin to PATH
export PATH="$(npm bin -g):$PATH"
```

### C.3 Wrong Version Displayed

**Symptom**: `shell-spec --version` shows wrong version

**Diagnosis**:
```bash
# Check which shell-spec
which shell-spec
type -a shell-spec  # Shows all matches in PATH

# Check VERSION file location
cat $(dirname $(which shell-spec))/../lib/shell-spec/VERSION
```

**Solution**:
Ensure only one installation exists, or reorder PATH.

---

*Document Version: 1.0*
*Last Updated: 2025-01-04*
*Status: Specification Complete - Ready for Implementation*
