# Shell-Spec v0.2.0 Specification: TAP Output Support

## Overview

**Version**: 0.2.0
**Feature**: Test Anything Protocol (TAP) Output
**Status**: Planned
**Complexity**: Simple
**Estimated Lines of Code**: ~80 (new), ~50 (modifications)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Architecture](#2-architecture)
3. [Functional Specification](#3-functional-specification)
4. [Technical Design](#4-technical-design)
5. [Workflows](#5-workflows)
6. [Use Cases](#6-use-cases)
7. [Decision Trees](#7-decision-trees)
8. [Logging & Diagnostics](#8-logging--diagnostics)
9. [Documentation Requirements](#9-documentation-requirements)
10. [Deliverables Checklist](#10-deliverables-checklist)
11. [Testing Strategy](#11-testing-strategy)
12. [Acceptance Criteria](#12-acceptance-criteria)

---

## 1. Executive Summary

### 1.1 Purpose

Add TAP (Test Anything Protocol) version 13 compliant output to shell-spec, enabling integration with CI/CD systems, TAP consumers (like `prove`), and standardized test reporting tools.

### 1.2 Goals

- Provide `--tap` flag for TAP-formatted output
- Maintain backward compatibility (default output unchanged)
- Support SKIP and TODO directives
- Include YAML diagnostic blocks for failures

### 1.3 Non-Goals

- Nested TAP streams (subtests)
- Custom YAML schema extensions
- TAP consumer/harness implementation

---

## 2. Architecture

### 2.1 Component Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         test_runner.sh                              │
│                                                                     │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐  │
│  │   Argument   │───▶│  Test        │───▶│  Output              │  │
│  │   Parser     │    │  Executor    │    │  Formatter           │  │
│  │              │    │              │    │                      │  │
│  │  --tap flag  │    │  Run tests   │    │  ┌────────────────┐  │  │
│  └──────────────┘    │  in subshell │    │  │ Default Mode   │  │  │
│                      └──────────────┘    │  │ (colors/table) │  │  │
│                             │            │  └────────────────┘  │  │
│                             │            │          OR          │  │
│                             ▼            │  ┌────────────────┐  │  │
│                      ┌──────────────┐    │  │ TAP Mode       │◀─┼──┼── NEW
│                      │  Test        │───▶│  │ (tap_reporter) │  │  │
│                      │  Results     │    │  └────────────────┘  │  │
│                      └──────────────┘    └──────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────┐
                    │    src/tap_reporter.sh   │  ◀── NEW FILE
                    │                          │
                    │  • tap_init()            │
                    │  • tap_plan()            │
                    │  • tap_ok()              │
                    │  • tap_not_ok()          │
                    │  • tap_skip()            │
                    │  • tap_todo()            │
                    │  • tap_diagnostic()      │
                    │  • is_tap_mode()         │
                    └──────────────────────────┘
```

### 2.2 File Structure

```
src/
├── test_runner.sh      # MODIFY: Add --tap flag, integrate TAP output
├── tap_reporter.sh     # NEW: TAP formatting functions
├── assertions.sh       # NO CHANGE
└── report_template.html # NO CHANGE
```

### 2.3 Data Flow

```
┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌──────────┐
│  Test   │────▶│   Execute   │────▶│   Format    │────▶│  stdout  │
│  Files  │     │   in shell  │     │   Output    │     │          │
└─────────┘     └─────────────┘     └─────────────┘     └──────────┘
                      │                    │
                      │                    ├── Default: Colors + Table
                      │                    │
                      ▼                    └── TAP: TAP 13 stream
               ┌─────────────┐
               │ exit_code,  │
               │ output,     │
               │ duration    │
               └─────────────┘
```

---

## 3. Functional Specification

### 3.1 Command Line Interface

```bash
# Enable TAP output
shell-spec --tap

# TAP with specific test pattern
shell-spec --tap "*_test.sh"

# TAP with path
shell-spec --tap tests/

# Combine with other flags (TAP takes precedence over verbose)
shell-spec --tap --verbose  # TAP output only, verbose ignored
shell-spec --tap --html report.html  # Both TAP stdout and HTML file
```

### 3.2 TAP Output Format

#### 3.2.1 Version Header
```
TAP version 13
```

#### 3.2.2 Test Plan
```
1..N
```
Where N is the total number of tests discovered.

#### 3.2.3 Test Results

**Passing test:**
```
ok 1 - test_function_name
```

**Failing test with YAML diagnostic:**
```
not ok 2 - test_another_function
  ---
  message: 'Expected "hello", got "world"'
  severity: fail
  file: ./tests/example_test.sh
  function: test_another_function
  duration_ms: 45
  ...
```

**Skipped test:**
```
ok 3 - test_not_ready # SKIP reason for skipping
```

**TODO test (expected failure):**
```
not ok 4 - test_work_in_progress # TODO known issue
```

### 3.3 Output Mode Exclusivity

| Flag Combination | Behavior |
|------------------|----------|
| (none) | Default: progress bar, table, summary |
| `--tap` | TAP output only, no colors/table |
| `--verbose` | Verbose default output |
| `--tap --verbose` | TAP output only (TAP wins) |
| `--tap --html X` | TAP to stdout, HTML to file |
| `--watch --tap` | Watch mode with TAP output on each run |

---

## 4. Technical Design

### 4.1 New File: `src/tap_reporter.sh`

```bash
#!/bin/bash
# =============================================================================
# tap_reporter.sh - TAP (Test Anything Protocol) v13 Reporter
# =============================================================================
#
# Part of shell-spec testing framework
# https://github.com/southpawriter02/shell-spec
#
# This module provides functions for generating TAP v13 compliant output.
# TAP is a simple text-based interface between testing modules and test
# harnesses, enabling integration with tools like prove, Jenkins, etc.
#
# Usage:
#   source tap_reporter.sh
#   tap_init
#   tap_plan 5
#   tap_ok "test passed"
#   tap_not_ok "test failed" "error message"
#
# See: https://testanything.org/tap-version-13-specification.html
# =============================================================================

# === Configuration ===
readonly TAP_VERSION="13"
_TAP_TEST_NUMBER=0
_TAP_MODE=false

# === Initialization ===

# tap_init: Print TAP version header and enable TAP mode
tap_init() {
    _TAP_MODE=true
    _TAP_TEST_NUMBER=0
    echo "TAP version $TAP_VERSION"
}

# tap_plan: Print test plan (call after discovery, before execution)
# Args: $1 = total number of tests
tap_plan() {
    local total="$1"
    echo "1..$total"
}

# === Test Result Functions ===

# tap_ok: Report a passing test
# Args: $1 = description, $2 = directive (optional: SKIP/TODO)
tap_ok() {
    local description="$1"
    local directive="${2:-}"

    ((_TAP_TEST_NUMBER++))

    if [[ -n "$directive" ]]; then
        echo "ok $_TAP_TEST_NUMBER - $description # $directive"
    else
        echo "ok $_TAP_TEST_NUMBER - $description"
    fi
}

# tap_not_ok: Report a failing test with optional YAML diagnostics
#
# Outputs a TAP "not ok" line with an optional YAML diagnostic block
# containing failure details for debugging.
#
# Arguments:
#   $1 - description  : Test description (required)
#   $2 - message      : Failure message (optional)
#   $3 - file         : Source file path (optional)
#   $4 - function     : Function name (optional)
#   $5 - duration_ms  : Test duration in milliseconds (optional, default: 0)
#   $6 - directive    : TAP directive like "TODO reason" (optional)
#
# Output:
#   not ok N - description
#     ---
#     message: 'failure message'
#     severity: fail
#     ...
#
# Example:
#   tap_not_ok "should handle empty input" "Expected error, got success"
#
tap_not_ok() {
    local description="$1"
    local message="${2:-}"
    local file="${3:-}"
    local func="${4:-}"
    local duration="${5:-0}"
    local directive="${6:-}"

    ((_TAP_TEST_NUMBER++))

    if [[ -n "$directive" ]]; then
        echo "not ok $_TAP_TEST_NUMBER - $description # $directive"
    else
        echo "not ok $_TAP_TEST_NUMBER - $description"
    fi

    # YAML diagnostic block (only if we have details)
    if [[ -n "$message" || -n "$file" ]]; then
        echo "  ---"
        if [[ -n "$message" ]]; then
            # Escape single quotes in message
            local safe_message="${message//\'/\'\'}"
            echo "  message: '$safe_message'"
        fi
        echo "  severity: fail"
        [[ -n "$file" ]] && echo "  file: '$file'"
        [[ -n "$func" ]] && echo "  function: '$func'"
        [[ "$duration" -gt 0 ]] && echo "  duration_ms: $duration"
        echo "  ..."
    fi
}

# tap_skip: Report a skipped test
# Args: $1 = description, $2 = reason (optional)
tap_skip() {
    local description="$1"
    local reason="${2:-}"

    ((_TAP_TEST_NUMBER++))

    if [[ -n "$reason" ]]; then
        echo "ok $_TAP_TEST_NUMBER - $description # SKIP $reason"
    else
        echo "ok $_TAP_TEST_NUMBER - $description # SKIP"
    fi
}

# tap_todo: Report a TODO test (expected failure is ok, unexpected pass is bonus)
# Args: $1 = description, $2 = passed (true/false), $3 = reason (optional)
tap_todo() {
    local description="$1"
    local passed="$2"
    local reason="${3:-}"

    ((_TAP_TEST_NUMBER++))

    local status="not ok"
    [[ "$passed" == "true" ]] && status="ok"

    if [[ -n "$reason" ]]; then
        echo "$status $_TAP_TEST_NUMBER - $description # TODO $reason"
    else
        echo "$status $_TAP_TEST_NUMBER - $description # TODO"
    fi
}

# === Utility Functions ===

# tap_diagnostic: Print a diagnostic comment
# Args: $1 = message
tap_diagnostic() {
    echo "# $1"
}

# is_tap_mode: Check if TAP mode is active
# Returns: 0 if TAP mode, 1 otherwise
is_tap_mode() {
    [[ "$_TAP_MODE" == "true" ]]
}

# tap_get_test_number: Get current test number (for external tracking)
tap_get_test_number() {
    echo "$_TAP_TEST_NUMBER"
}
```

### 4.2 Modifications to `src/test_runner.sh`

#### 4.2.1 Add TAP_MODE variable (line ~9)

```bash
# --- Configuration & Defaults ---
TEST_FILE_PATTERN="*_test.sh"
TEST_FUNCTION_PREFIX="test_"
HTML_REPORT_FILE=""
VERBOSE=false
WATCH_MODE=false
TAP_MODE=false  # NEW
```

#### 4.2.2 Source TAP reporter (after line 30)

```bash
source "$SCRIPT_DIR/assertions.sh"
source "$SCRIPT_DIR/tap_reporter.sh"  # NEW
```

#### 4.2.3 Add --tap argument parsing (in case block, ~line 45)

```bash
    --tap)
      TAP_MODE=true
      shift
      ;;
```

#### 4.2.4 Initialize TAP output (after test discovery, ~line 126)

```bash
  if [ "$total_tests" -eq 0 ]; then
     echo "No tests found."
     return 0
  fi

  # NEW: TAP initialization
  if $TAP_MODE; then
    tap_init
    tap_plan "$total_tests"
  elif ! $VERBOSE; then
    echo "Found $total_tests tests."
  fi
```

#### 4.2.5 Replace result output in execution loop (~lines 166-180)

```bash
    if [ $exit_code -eq 0 ]; then
      tests_passed=$((tests_passed + 1))
      if $TAP_MODE; then
        tap_ok "$func"
      elif $VERBOSE; then
        echo -e "  - ${COLOR_GREEN}PASS: $func${COLOR_RESET} (${duration}ms)"
        if [ -n "$output" ]; then echo "$output"; fi
      fi
      append_json_result "$file" "$func" "PASS" "" "$duration"
    else
      tests_failed=$((tests_failed + 1))
      if $TAP_MODE; then
        tap_not_ok "$func" "$output" "$file" "$func" "$duration"
      elif $VERBOSE; then
        echo -e "  - ${COLOR_RED}FAIL: $func${COLOR_RESET} (${duration}ms)"
        if [ -n "$output" ]; then echo "$output"; fi
      fi
      append_json_result "$file" "$func" "FAIL" "$output" "$duration"
    fi
```

#### 4.2.6 Suppress default output in TAP mode (~lines 183-230)

```bash
  # Suppress progress bar completion, table, and summary in TAP mode
  if ! $TAP_MODE; then
    if ! $VERBOSE; then
      echo "" # Newline after progress bar
    fi

    # --- Summary Table ---
    # ... existing table code ...

    # --- Text Summary ---
    # ... existing summary code ...
  fi
```

---

## 5. Workflows

### 5.1 Standard TAP Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    User runs: shell-spec --tap                  │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Parse arguments                                              │
│    • Set TAP_MODE=true                                          │
│    • Source tap_reporter.sh                                     │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Discover tests                                               │
│    • Find *_test.sh files                                       │
│    • Extract test_* functions                                   │
│    • Count total tests (N)                                      │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Output TAP header                                            │
│    stdout: TAP version 13                                       │
│    stdout: 1..N                                                 │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Execute tests (loop)                                         │
│    For each test:                                               │
│    ┌───────────────────────────────────────────────────────┐    │
│    │ • Run in subshell                                     │    │
│    │ • Capture exit code, output, duration                 │    │
│    │ • If pass: tap_ok "$func"                             │    │
│    │ • If fail: tap_not_ok "$func" "$output" ...           │    │
│    └───────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. Exit with appropriate code                                   │
│    • All pass: exit 0                                           │
│    • Any fail: exit 1                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 CI/CD Integration Flow

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  CI Pipeline    │────▶│  shell-spec     │────▶│  TAP Consumer   │
│  (e.g. GitHub   │     │  --tap          │     │  (e.g. prove,   │
│   Actions)      │     │                 │     │   tap-parser)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                        │
                               ▼                        ▼
                        ┌─────────────┐          ┌─────────────┐
                        │ TAP stream  │          │ Parsed      │
                        │ to stdout   │          │ results     │
                        └─────────────┘          └─────────────┘
                               │                        │
                               ▼                        ▼
                        ┌─────────────┐          ┌─────────────┐
                        │ Exit code   │          │ Report/     │
                        │ 0 or 1      │          │ Dashboard   │
                        └─────────────┘          └─────────────┘
```

### 5.3 Watch Mode with TAP

```
┌─────────────────────────────────────────────────────────────────┐
│              User runs: shell-spec --watch --tap                │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │   Start watch loop     │
                    └────────────────────────┘
                                 │
              ┌──────────────────┴──────────────────┐
              │                                     │
              ▼                                     │
    ┌──────────────────┐                            │
    │ Check file       │                            │
    │ modification     │                            │
    └──────────────────┘                            │
              │                                     │
              ▼                                     │
    ┌──────────────────┐    No change              │
    │ Changed?         │─────────────────────────▶│
    └──────────────────┘                            │
              │ Yes                                 │
              ▼                                     │
    ┌──────────────────┐                            │
    │ Clear screen     │                            │
    │ Run tests (TAP)  │                            │
    │ Output:          │                            │
    │   TAP version 13 │                            │
    │   1..N           │                            │
    │   ok 1 - ...     │                            │
    │   ...            │                            │
    └──────────────────┘                            │
              │                                     │
              └─────────────sleep 2s────────────────┘
```

---

## 6. Use Cases

### 6.1 UC-01: Basic TAP Output for CI

**Actor**: Developer / CI System
**Precondition**: Test files exist in project
**Trigger**: Run `shell-spec --tap`

**Flow**:
1. Developer configures CI to run `shell-spec --tap`
2. CI executes command
3. TAP stream output to stdout
4. CI parses TAP or uses exit code
5. Build passes/fails based on results

**Output**:
```
TAP version 13
1..3
ok 1 - test_addition
ok 2 - test_subtraction
not ok 3 - test_division
  ---
  message: 'Division by zero not handled'
  severity: fail
  file: './tests/math_test.sh'
  function: 'test_division'
  duration_ms: 12
  ...
```

### 6.2 UC-02: TAP with `prove` Harness

**Actor**: Developer
**Precondition**: Perl `prove` utility installed
**Trigger**: Run `prove --exec 'shell-spec --tap' tests/`

**Flow**:
1. Developer runs prove command
2. prove executes shell-spec --tap for each test file
3. prove aggregates TAP streams
4. prove displays summary report

**Example**:
```bash
$ prove --exec 'bash src/test_runner.sh --tap' examples/
examples/example_test.sh .. ok
All tests successful.
Files=1, Tests=8, 0 wallclock secs
Result: PASS
```

### 6.3 UC-03: Skip Tests

**Actor**: Developer
**Precondition**: Test function marked with SKIP comment

**Test File**:
```bash
# @SKIP Database not available in CI
test_database_connection() {
    # This test requires local database
    assert_success "psql -c 'SELECT 1'"
}
```

**Output**:
```
ok 5 - test_database_connection # SKIP Database not available in CI
```

### 6.4 UC-04: TODO Tests (Known Failures)

**Actor**: Developer
**Precondition**: Test function marked with TODO comment

**Test File**:
```bash
# @TODO Fix in v1.1
test_edge_case_handling() {
    # Known bug, expected to fail
    assert_equals "expected" "actual"
}
```

**Output**:
```
not ok 6 - test_edge_case_handling # TODO Fix in v1.1
```

### 6.5 UC-05: Combined TAP + HTML Report

**Actor**: Developer
**Trigger**: Run `shell-spec --tap --html report.html`

**Flow**:
1. TAP output streams to stdout
2. HTML report generated to file
3. Both outputs available

**Result**:
- stdout: TAP stream
- report.html: Visual HTML dashboard

---

## 7. Decision Trees

### 7.1 Output Mode Selection

```
                    ┌─────────────────┐
                    │  --tap flag?    │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ Yes                         │ No
              ▼                             ▼
    ┌──────────────────┐          ┌──────────────────┐
    │ TAP Output Mode  │          │  --verbose flag? │
    │                  │          └────────┬─────────┘
    │ • No colors      │                   │
    │ • No progress    │        ┌──────────┴──────────┐
    │ • No table       │        │ Yes                 │ No
    │ • TAP stream     │        ▼                     ▼
    └──────────────────┘   ┌─────────────┐    ┌─────────────┐
                           │ Verbose Mode│    │ Default Mode│
                           │             │    │             │
                           │ • Per-test  │    │ • Progress  │
                           │   output    │    │   bar       │
                           │ • Full logs │    │ • Table     │
                           └─────────────┘    │ • Summary   │
                                              └─────────────┘
```

### 7.2 Test Result Reporting

```
                    ┌─────────────────┐
                    │  Test executed  │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    │  Exit code = 0? │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ Yes (Pass)                  │ No (Fail)
              ▼                             ▼
    ┌──────────────────┐          ┌──────────────────┐
    │  Has SKIP        │          │  Has TODO        │
    │  directive?      │          │  directive?      │
    └────────┬─────────┘          └────────┬─────────┘
             │                             │
      ┌──────┴──────┐               ┌──────┴──────┐
      │Yes          │No             │Yes          │No
      ▼             ▼               ▼             ▼
   ┌──────┐    ┌──────┐        ┌──────┐     ┌──────┐
   │ ok   │    │ ok   │        │not ok│     │not ok│
   │ # SKIP│   │      │        │# TODO│     │+ YAML│
   └──────┘    └──────┘        └──────┘     └──────┘
```

### 7.3 Directive Detection

```
                    ┌─────────────────────────┐
                    │  Parse test function    │
                    │  for directives         │
                    └───────────┬─────────────┘
                                │
                    ┌───────────┴───────────┐
                    │  Check preceding      │
                    │  comment line         │
                    └───────────┬───────────┘
                                │
              ┌─────────────────┼─────────────────┐
              │                 │                 │
              ▼                 ▼                 ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │ # @SKIP ...  │  │ # @TODO ...  │  │ No directive │
    └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
           │                 │                 │
           ▼                 ▼                 ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │ directive=   │  │ directive=   │  │ directive=   │
    │ "SKIP ..."   │  │ "TODO ..."   │  │ ""           │
    └──────────────┘  └──────────────┘  └──────────────┘
```

---

## 8. Logging & Diagnostics

### 8.1 TAP Diagnostic Comments

TAP allows diagnostic comments (lines starting with `#`) for debugging:

```
# Starting test suite: math_test.sh
# Discovered 5 test functions
TAP version 13
1..5
# Running: test_addition
ok 1 - test_addition
# Running: test_subtraction
ok 2 - test_subtraction
# WARNING: test_division took 5023ms (slow)
not ok 3 - test_division
  ---
  message: 'Timeout exceeded'
  ...
```

### 8.2 YAML Diagnostic Block Schema

For failing tests, include structured YAML:

```yaml
---
message: 'Human-readable failure description'
severity: fail
file: './path/to/test_file.sh'
function: 'test_function_name'
duration_ms: 123
expected: 'expected value (if applicable)'
actual: 'actual value (if applicable)'
...
```

### 8.3 Debug Mode (Future Enhancement)

For v0.2.0, diagnostics are minimal. Future versions may add:
- `--tap --debug` for verbose TAP diagnostics
- Timing thresholds for slow test warnings
- Memory/resource usage in YAML blocks

---

## 9. Documentation Requirements

### 9.1 Inline Documentation

#### 9.1.1 Source File Headers

All new source files must include a header block:

```bash
#!/bin/bash
# =============================================================================
# tap_reporter.sh - TAP (Test Anything Protocol) v13 Reporter
# =============================================================================
#
# Part of shell-spec testing framework
# https://github.com/southpawriter02/shell-spec
#
# This module provides functions for generating TAP v13 compliant output.
# ...
# =============================================================================
```

#### 9.1.2 Function Documentation

All functions must include docstrings:

```bash
# function_name: Brief description
#
# Detailed description of what the function does.
#
# Arguments:
#   $1 - param_name : Description (required/optional)
#   $2 - param_name : Description (optional, default: value)
#
# Output:
#   Description of stdout output
#
# Returns:
#   Exit code meaning
#
# Example:
#   function_name "arg1" "arg2"
#
```

### 9.2 Peripheral Documentation

#### 9.2.1 README.md Updates

Add TAP section to README.md:

```markdown
## TAP Output

shell-spec supports TAP (Test Anything Protocol) version 13 output for CI/CD
integration:

### Basic Usage

```bash
shell-spec --tap
```

### Output Format

```
TAP version 13
1..3
ok 1 - test_addition
ok 2 - test_subtraction
not ok 3 - test_division
  ---
  message: 'Division by zero'
  ...
```

### CI Integration

#### GitHub Actions

```yaml
- name: Run tests
  run: shell-spec --tap
```

#### With prove (Perl TAP harness)

```bash
prove --exec 'shell-spec --tap' tests/
```

### Directives

Mark tests as skipped or TODO with comments:

```bash
# @SKIP Requires database
test_db_connection() { ... }

# @TODO Known issue #123
test_edge_case() { ... }
```
```

### 9.3 Changelog Entry

```markdown
## [0.2.0] - YYYY-MM-DD

### Added
- TAP (Test Anything Protocol) v13 output support via `--tap` flag
- New file: `src/tap_reporter.sh` with TAP formatting functions
- YAML diagnostic blocks for test failures
- Support for SKIP and TODO directives via comment annotations
- Integration with `prove` and other TAP consumers

### Changed
- test_runner.sh now sources tap_reporter.sh
- Output formatting is now mode-aware (default vs TAP)
```

---

## 10. Deliverables Checklist

### 10.1 Code Deliverables

- [ ] **src/tap_reporter.sh** (new file, ~80 lines)
  - [ ] `tap_init()` - Initialize TAP mode, print version
  - [ ] `tap_plan()` - Print test plan
  - [ ] `tap_ok()` - Report passing test
  - [ ] `tap_not_ok()` - Report failing test with YAML
  - [ ] `tap_skip()` - Report skipped test
  - [ ] `tap_todo()` - Report TODO test
  - [ ] `tap_diagnostic()` - Print diagnostic comment
  - [ ] `is_tap_mode()` - Check if TAP mode active
  - [ ] File header documentation
  - [ ] Function documentation for all functions

- [ ] **src/test_runner.sh** (modifications, ~50 lines changed)
  - [ ] Add `TAP_MODE=false` variable
  - [ ] Add `source "$SCRIPT_DIR/tap_reporter.sh"`
  - [ ] Add `--tap)` case in argument parser
  - [ ] Add TAP initialization after test discovery
  - [ ] Modify execution loop to call TAP functions
  - [ ] Wrap default output in `if ! $TAP_MODE` blocks

### 10.2 Test Deliverables

- [ ] **tests/tap_reporter_test.sh** (new test file)
  - [ ] Test `tap_ok` output format
  - [ ] Test `tap_not_ok` output format
  - [ ] Test `tap_not_ok` YAML block
  - [ ] Test `tap_skip` output format
  - [ ] Test `tap_todo` output format
  - [ ] Test `tap_plan` output format
  - [ ] Test `tap_diagnostic` output format
  - [ ] Test special character escaping

- [ ] **tests/integration/tap_mode_test.sh** (integration tests)
  - [ ] Test full TAP output with passing tests
  - [ ] Test full TAP output with failing tests
  - [ ] Test `--tap` flag parsing
  - [ ] Test `--tap --html` combination
  - [ ] Test `--tap --watch` combination
  - [ ] Test exit code with TAP mode

### 10.3 Documentation Deliverables

- [ ] **README.md** updates
  - [ ] TAP output section
  - [ ] Usage examples
  - [ ] CI integration examples

- [ ] **CHANGELOG.md** entry
  - [ ] v0.2.0 release notes

- [ ] **Inline documentation**
  - [ ] tap_reporter.sh file header
  - [ ] All function docstrings

### 10.4 Validation Deliverables

- [ ] TAP output validates against TAP 13 spec
- [ ] Works with `prove` harness
- [ ] Exit code 0 when all tests pass
- [ ] Exit code 1 when any test fails
- [ ] No regression in default output mode

---

## 11. Testing Strategy

### 11.1 Unit Tests

Test individual TAP reporter functions:

```bash
# tests/tap_reporter_test.sh

test_tap_ok_basic() {
    source src/tap_reporter.sh
    tap_init > /dev/null

    output=$(tap_ok "my test description")
    assert_equals "ok 1 - my test description" "$output"
}

test_tap_ok_with_skip() {
    source src/tap_reporter.sh
    tap_init > /dev/null

    output=$(tap_ok "skipped test" "SKIP no database")
    assert_equals "ok 1 - skipped test # SKIP no database" "$output"
}

test_tap_not_ok_with_yaml() {
    source src/tap_reporter.sh
    tap_init > /dev/null

    output=$(tap_not_ok "failed test" "Expected 1, got 2" "test.sh" "test_func" 100)
    assert_output_contains "not ok 1 - failed test" "$output"
    assert_output_contains "message: 'Expected 1, got 2'" "$output"
    assert_output_contains "duration_ms: 100" "$output"
}
```

### 11.2 Integration Tests

Test TAP mode end-to-end:

```bash
# tests/integration/tap_mode_test.sh

test_tap_mode_output_format() {
    output=$(bash src/test_runner.sh --tap examples/)

    assert_output_contains "TAP version 13" "$output"
    assert_output_contains "1.." "$output"
    assert_output_contains "ok " "$output"
}

test_tap_mode_exit_code_pass() {
    # Create temp test that passes
    echo 'test_pass() { true; }' > /tmp/pass_test.sh

    bash src/test_runner.sh --tap /tmp/pass_test.sh
    assert_equals 0 $?

    rm /tmp/pass_test.sh
}

test_tap_mode_exit_code_fail() {
    # Create temp test that fails
    echo 'test_fail() { false; }' > /tmp/fail_test.sh

    bash src/test_runner.sh --tap /tmp/fail_test.sh
    assert_equals 1 $?

    rm /tmp/fail_test.sh
}
```

### 11.3 Compatibility Tests

```bash
test_tap_with_prove() {
    # Skip if prove not installed
    command -v prove >/dev/null || skip "prove not installed"

    output=$(prove --exec 'bash src/test_runner.sh --tap' examples/ 2>&1)
    assert_output_contains "All tests successful" "$output"
}
```

### 11.4 Regression Tests

Ensure default mode still works:

```bash
test_default_mode_unchanged() {
    output=$(bash src/test_runner.sh examples/)

    # Should have progress bar output
    assert_output_contains "Running tests:" "$output"
    # Should have table
    assert_output_contains "| File" "$output"
    # Should NOT have TAP header
    assert_output_not_contains "TAP version" "$output"
}
```

---

## 12. Acceptance Criteria

### 12.1 Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-01 | `--tap` flag produces TAP v13 output | Run `shell-spec --tap`, verify output starts with `TAP version 13` |
| AC-02 | Plan line shows correct count | Create 5 tests, verify output contains `1..5` |
| AC-03 | Passing tests show `ok N - description` | Run passing test, verify `ok` line format |
| AC-04 | Failing tests show `not ok N - description` | Run failing test, verify `not ok` line format |
| AC-05 | Failing tests include YAML diagnostics | Run failing test, verify `---` block present |
| AC-06 | SKIP directive works | Mark test with `# @SKIP`, verify `# SKIP` in output |
| AC-07 | TODO directive works | Mark test with `# @TODO`, verify `# TODO` in output |
| AC-08 | Exit code 0 when all pass | Run all-passing suite with `--tap`, verify `$? = 0` |
| AC-09 | Exit code 1 when any fail | Run suite with failure, verify `$? = 1` |
| AC-10 | Default mode unaffected | Run without `--tap`, verify normal output |

### 12.2 Compatibility Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| CC-01 | Works with Perl `prove` | Run `prove --exec 'shell-spec --tap'`, verify success |
| CC-02 | Works with `tap-parser` (Node.js) | Pipe output to tap-parser, verify no errors |
| CC-03 | Valid TAP 13 syntax | Validate output against TAP 13 grammar |

### 12.3 Integration Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| IC-01 | `--tap --html` both work | Run with both flags, verify TAP to stdout and HTML file created |
| IC-02 | `--tap --watch` both work | Run in watch mode with TAP, verify TAP output on file change |
| IC-03 | `--tap --verbose` TAP wins | Run with both flags, verify TAP output (not verbose) |

---

## Appendix A: TAP 13 Specification Summary

### TAP Grammar

```
TAP         := Version Plan Body | Version Body Plan
Version     := "TAP version 13\n"
Plan        := "1.." Number "\n"
Body        := Line*
Line        := TestLine | Diagnostic | YAML | Pragma | Anything
TestLine    := Status Number? Description? Directive? "\n"
Status      := "ok " | "not ok "
Number      := [0-9]+
Description := "- " [^\n#]+
Directive   := "#" ("SKIP" | "TODO") Reason?
Reason      := [^\n]+
Diagnostic  := "#" [^\n]* "\n"
YAML        := "  ---\n" YAMLBlock "  ...\n"
```

### References

- [TAP Version 13 Specification](https://testanything.org/tap-version-13-specification.html)
- [TAP Consumers](https://testanything.org/consumers.html)
- [prove(1) Manual](https://metacpan.org/pod/prove)

---

## Appendix B: Example Full TAP Output

```
TAP version 13
1..8
# Starting test run
ok 1 - test_assert_equals_pass
ok 2 - test_assert_not_equals_pass
not ok 3 - test_assert_equals_fail
  ---
  message: 'FAIL: Expected "hello", got "world"'
  severity: fail
  file: './examples/example_test.sh'
  function: 'test_assert_equals_fail'
  duration_ms: 23
  ...
ok 4 - test_command_success
ok 5 - test_command_failure
ok 6 - test_output_contains
ok 7 - test_file_exists
ok 8 - test_variable_is_set # SKIP CI environment lacks variable
# Test run complete
```

---

*Document Version: 1.0*
*Last Updated: 2025-01-04*
*Status: Specification Complete - Ready for Implementation*
