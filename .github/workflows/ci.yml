# =============================================================================
# ci.yml - Continuous Integration for shell-spec
# =============================================================================
#
# This workflow runs on every push to main and on pull requests.
# It performs:
#   1. Static analysis (ShellCheck)
#   2. Test matrix (multiple OS × shell combinations)
#   3. Portability testing (Alpine Linux)
#
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Lint Job - Static analysis with ShellCheck
  # ===========================================================================
  lint:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.'
          severity: warning
          format: tty
        env:
          SHELLCHECK_OPTS: --rcfile=.shellcheckrc

      - name: Lint summary
        if: always()
        run: |
          echo "## ShellCheck Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ All shell scripts passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ ShellCheck found issues" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Test Job - Matrix testing across OS and shells
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.shell }})
    runs-on: ${{ matrix.os }}
    needs: lint  # Only run if lint passes

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-13]
        shell: [bash, zsh]
        include:
          # Add sh testing for Linux only
          - os: ubuntu-latest
            shell: sh
          - os: ubuntu-22.04
            shell: sh
        exclude:
          # sh (dash) behaves differently on macOS, skip for now
          - os: macos-latest
            shell: sh
          - os: macos-13
            shell: sh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install zsh (Ubuntu)
        if: matrix.shell == 'zsh' && startsWith(matrix.os, 'ubuntu')
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Get shell version
        id: shell-version
        run: |
          case "${{ matrix.shell }}" in
            bash) echo "version=$(${{ matrix.shell }} --version | head -1)" >> $GITHUB_OUTPUT ;;
            zsh)  echo "version=$(${{ matrix.shell }} --version)" >> $GITHUB_OUTPUT ;;
            sh)   echo "version=$(readlink -f /bin/sh) - $(/bin/sh --version 2>&1 | head -1 || echo 'unknown')" >> $GITHUB_OUTPUT ;;
          esac

      - name: Display test environment
        run: |
          echo "## Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.shell-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Run tests
        run: |
          echo "Running shell-spec tests with ${{ matrix.shell }}..."
          ${{ matrix.shell }} src/test_runner.sh
        env:
          SHELL_SPEC_CI: 'true'

      - name: Run tests with TAP output
        if: success() || failure()
        run: |
          echo "Running tests with TAP output..."
          ${{ matrix.shell }} src/test_runner.sh --tap || true

      - name: Test summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Tests passed on ${{ matrix.os }} with ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed on ${{ matrix.os }} with ${{ matrix.shell }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Portability Job - Alpine Linux (musl libc)
  # ===========================================================================
  portability:
    name: Portability (Alpine/musl)
    runs-on: ubuntu-latest
    needs: lint
    container:
      image: alpine:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display environment
        run: |
          echo "Shell: $(readlink -f /bin/sh)"
          echo "libc: $(ldd --version 2>&1 | head -1 || echo 'musl')"
          cat /etc/os-release

      - name: Run tests with sh
        run: |
          echo "Running portability tests on Alpine Linux..."
          /bin/sh src/test_runner.sh

      - name: Portability summary
        if: always()
        run: |
          echo "## Portability Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Alpine Linux (musl libc)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: /bin/sh (BusyBox ash)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Portability tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Portability tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Summary Job - Aggregate results
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, portability]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Matrix | ${{ needs.test.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Portability | ${{ needs.portability.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.portability.result }}" != "success" ]; then
            echo ""
            echo "❌ **CI Failed** - See individual job logs for details" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo ""
          echo "✅ **All CI checks passed!**" >> $GITHUB_STEP_SUMMARY
