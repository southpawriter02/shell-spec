#!/bin/bash
#
# sh-unit: A shell script testing framework.
# This script is the main test runner.

# Function to discover test files
discover_tests() {
  find . -name "*_test.sh"
}

# Source the assertion library
. "$(dirname "$0")/assertions.sh"

# Function to run tests from a given file
run_tests_in_file() {
  local test_file="$1"
  echo "Running tests in: $test_file"

  # Source the test file in a subshell to avoid polluting the runner's environment
  # and get the list of test functions.
  local test_functions=$( ( . "$test_file"; declare -F | awk '{print $3}' | grep "^test_" ) )

  for func in $test_functions; do
    echo "  Running test: $func"
    # Source the assertion library and the test file, then run the test function.
    # The whole thing runs in a subshell for isolation.
    (
      . "$(dirname "$0")/assertions.sh"
      . "$test_file"
      "$func"
    )
    local exit_code=$?
    # The PASS/FAIL message is now handled by the assertion library.
    # We just check the exit code to see if the test function as a whole passed or failed.
    if [ $exit_code -ne 0 ]; then
        echo "    -> Test function failed."
    fi
  done
}

# Main execution
echo "Starting test run..."
for test_file in $(discover_tests); do
  run_tests_in_file "$test_file"
done
echo "Test run complete."
