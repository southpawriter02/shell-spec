#!/bin/bash
#
# sh-unit: A shell script testing framework.
# This script is the main test runner.

# Function to discover test files
discover_tests() {
  find . -name "*_test.sh"
}

# Function to run tests from a given file
run_tests_in_file() {
    local test_file="$1"
    echo "Running tests in: $test_file"

    # Source the test file in a subshell to get the list of test functions.
    local test_functions=$( ( . "$test_file"; declare -F | awk '{print $3}' | grep "^test_" ) )

    for func in $test_functions; do
        echo "  Running test: $func"
        # Source the assertions library and the test file in a subshell for isolation,
        # then run the test function.
        ( . "$basedir/assertions.sh"; . "$test_file"; "$func" )
        # We no longer check the exit code directly, as the assertions will print PASS/FAIL
    done
}

# Main execution
basedir=$(dirname "$0")
echo "Starting test run..."
for test_file in $(discover_tests); do
    run_tests_in_file "$test_file"
done
echo "Test run complete."
